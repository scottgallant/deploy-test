<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. Parallelizing Capistrano</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. Parallelizing Capistrano"/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
     
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Parallelizing Capistrano"/>
    <meta name="twitter:site" content="@roidrage"/>
    <meta name="twitter:creator" content="@roidrage"/>
    <meta name="twitter:description" content="On a recent project we ran into a situation where we needed a more advanced way of parallelizing Capistrano tasks than just using the parallel method it already sports. To jog your memory, parallel..."/>
    <meta name="twitter:url" content="http://www.paperplanes.de/2009/3/19/parallizing_capistrano.html"/>
    <meta name="twitter:domain" content="paperplanes.de"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <article class="hentry">
  <div class="item_perma">
    <div class="item_details">
      <header>
        <h3 class="entry-title">Parallelizing Capistrano</h3>
        <h4><a href="/2009/3/19/parallizing_capistrano.html" title="Permalink for this post">19 March 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </header>
    </div>
    <div class="item_content">
      <p>On a recent project we ran into a situation where we needed a more advanced way of parallelizing Capistrano tasks than just using the parallel method it already sports. To jog your memory, parallel can run arbitrary shell commands in parallel on different servers. So if you wanted your webserver to already restart the processes while you restart your background processes, you can do it like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallel do |session|
  session.when &#39;in?(:web)&#39;, &#39;script/spin&#39;
  session.when &#39;in?(:daemon)&#39;, &#39;script/daemons restart&#39;
end
</code></pre></div>
<p>You can even use it to run tasks in parallel on the same hosts, but it looks ugly, and it only works for shell commands. So we came up with a neat extension that lets you run arbitrary blocks of code in parallel. Obviously you&#39;d usually call tasks in those blocks, but who knows. Let&#39;s just have a look at an example.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallelize do |session|
  session.run { deploy.restart }
  session.run { daemons.restart }
end
</code></pre></div>
<p>Neat! We&#39;re aware that the name might not be perfect, suggestions welcome, but for now it&#39;ll do. What it does is run each block in a different thread. Due to some internal Capistrano limitations it also opens a new SSH session for each thread. That&#39;s a bit of a bummer, but we&#39;d have to rework a lot of the command code of Capistrano to get that to work with multiple threads. It also means that you should usually limit the amount of tasks you run at any one time, but thankfully you can either do that by setting the <code>parallelize_thread_count</code> variable. It defaults to ten concurrent thread. parallelize will run all the blocks in chunks corresponding to that size, and will only run the next chunk when all blocks in the first finished successfully.</p>

<p>You can also hand in the chunk size directly, since it sometimes just doesn&#39;t make sense to run as many tasks in one go as possible, especially when they&#39;re run on just one host. It might just take longer to run them all in parallel than to ran two batches one after the other. So it&#39;s easy to specify the chunk size for specific tasks.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallelize(5) do
  session.run { deploy.restart }
  session.run { daemons.restart }
end
</code></pre></div>
<p>If one of the tasks in the specified blocks causes a rollback or raises an error, then parallelize will run the rollback on all the other threads and on the main thread. Now, in general I wouldn&#39;t recommend running too many tasks in parallel that require big rollback procedures, but just in case you&#39;re into that sort of thing, knock yourself out.</p>

<p>We could see a considerable improvement in deployment speed, especially during the time-critical tasks. The project is up on <a href="http://github.com/mattmatt/cap-ext-parallelize">GitHub</a>, and it might just be moved into the capistrano-ext module in the future. Install using</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">gem install mattmatt-cap-ext-parallelize -s http://gems.github.com
</code></pre></div>
<p>And then in your Capfile, insert this line</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;cap_ext_parallelize&#39;
</code></pre></div>
<p>Let <a href="mailto:capistrano@peritor.com">us</a> know if you have any problems.</p>

    </div>
    <div class="item_meta">
      <div class="item_tags">Tags:
        
      </div>
      <div class="item_hierarchy">Hierarchy:
        
          <a href="/2009/3/18/mocking_is_so_2008.html" title="Previous post">previous</a>
        
        
        
          , <a href="/2009/3/22/xray_goggles_for_your_ruby_processes.html" title="Next post">next</a>
        
        </div>
    </div>
  </div>
</article>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
