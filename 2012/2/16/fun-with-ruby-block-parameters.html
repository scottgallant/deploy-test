<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. Fun with Ruby Block Parameters</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. Fun with Ruby Block Parameters"/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
     
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Fun with Ruby Block Parameters"/>
    <meta name="twitter:site" content="@roidrage"/>
    <meta name="twitter:creator" content="@roidrage"/>
    <meta name="twitter:description" content="I always forget what kinds of crazy things you can do with Ruby&#39;s blocks and
their parameters, so here&#39;s a little write-up on them. I regularly forget things
I&#39;ve learned (must be an ag..."/>
    <meta name="twitter:url" content="http://www.paperplanes.de/2012/2/16/fun-with-ruby-block-parameters.html"/>
    <meta name="twitter:domain" content="paperplanes.de"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <article class="hentry">
  <div class="item_perma">
    <div class="item_details">
      <header>
        <h3 class="entry-title">Fun with Ruby Block Parameters</h3>
        <h4><a href="/2012/2/16/fun-with-ruby-block-parameters.html" title="Permalink for this post">16 February 2012</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </header>
    </div>
    <div class="item_content">
      <p>I always forget what kinds of crazy things you can do with Ruby&#39;s blocks and
their parameters, so here&#39;s a little write-up on them. I regularly forget things
I&#39;ve learned (must be an age thing), and I found that not even books on the Ruby
language fully cover all the gory details on block (and method) parameters. So
consider this my personal reference of crazy Ruby block syntax features for future use.</p>

<h3>The Basics</h3>

<p>In its simplest form, a block parameter is a list of names, to which values
passed into the block are assigned. The following iterates over all elements in
the hash, emitting key and the corresponding value, printing both key and value.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(key, value) {puts key, value}
{username: &quot;roidrage&quot;, fullname: &quot;Mathias Meyer&quot;}.each &amp;blk
</code></pre></div>
<p>Yes, that&#39;s the boring bit, bear with me.</p>

<h3>Splat Parameters</h3>

<p>You can use splat parameters too, catching an array of all arguments.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(*args) {puts args}
blk.(1, 2, 3) 
# =&gt; [1, 2, 3]
</code></pre></div>
<p>Notice that crazy syntax for calling the block too, pretty wild. The fun starts
when you combine a splat parameter with one that&#39;s fixed.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(first, *tail) {puts first}
blk.(1, 2, 3)
# =&gt; 1
</code></pre></div>
<p>Why not put another fixed parameter at the end? That&#39;ll assign the first element of
the arguments to the variable <code>first</code>, the last element to <code>last</code>, and
everything in between to <code>middle</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(first, *middle, last) {puts last}
blk.(1, 2, 3)
# =&gt; 3
</code></pre></div>
<p>This can grow to an arbitrary complexity, adding more fixed parameters before
and after a splat. In this example, <code>middle</code> will just be an empty array, as the
fixed parameters are greedy and steal all the values they can match.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(first, *middle, second_last, last) {puts second_last}
blk.(1, 2, 3)
# =&gt; 2
</code></pre></div>
<p>Fortunately you can have only one splat parameter.</p>

<p>Just for fun, you can also just specify the splat operator and nothing else.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(*) {puts &quot;lolwut?&quot;}
</code></pre></div>
<h3>Default parameters</h3>

<p>If you want to save some time, you can assign default values to block
parameters.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(list = [1, 2, 3]) {list.sample}
blk.()
</code></pre></div>
<p>Again, you knew that already. Here&#39;s some craziness though, courtesy of
<a href="https://gist.github.com/1528785">Avdi</a>.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;list = (default = true; [1, 2, 3]) {puts default}
blk.()
# =&gt; true
blk.([4, 5, 6])
# =&gt; nil
</code></pre></div>
<h3>Referencing Other Parameters</h3>

<p>You can reference parameters previously defined in the list. Want to do an
impromptu mapping on the list above before even entering the block?</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(list = [1, 2, 3], sum=list.inject(1) {|acc, value| acc*value})) {
  list.sample
}
</code></pre></div>
<p>Don&#39;t do that, though. But good to know you can. Note that it only works for
parameters listed before the one you&#39;re assigning to. You can also shorten the
example above by quite a bit.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(list = [1, 2, 3], sum=list.inject(:*)) {
  list.sample
}
</code></pre></div>
<h3>Block-local parameters</h3>

<p>To add more character variety, you can declare variables local to the block by
adding a semicolon and another list of parameters. Helps when you want to make
sure variables used in the block don&#39;t accidentally overwrite or reference
variables outside the block&#39;s scope. Blocks are closures, so they reference
their environment, including variables declared outside the block.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">username = &quot;roidrage&quot;
blk = -&gt;(tags; username) {username = &quot;mathias&quot;}
blk.([&quot;nosql&quot;, &quot;cloud&quot;])
puts username
# =&gt; &quot;roidrage&quot;
</code></pre></div>
<p>You&#39;ll be pleased to hear that there&#39;s no craziness you can do with block local
parameters, like assigning defaults.</p>

<h3>Ignoring arguments</h3>

<p>This one may look familiar to folks knowledgeable in Erlang. You can ignore
specific arguments using <code>_</code>. Combine that with the splat parameter and you can
extract the tail of a list while ignoring the first element. Then you can
recursively iterate through the tail, ignoring the first element.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">blk = -&gt;(_, *tail) {blk.(tail) if tail.size &gt; 0}
</code></pre></div>
<p>When is this useful? Ruby is not a pattern-matching language after all. For
instance, imagine an API that expects blocks handed to a method call to expect a
certain number of arguments. Ruby gives you warning if the block&#39;s arity doesn&#39;t
match the number it was called with. This way you can silently dump parameters
you&#39;re not interested in while still conforming to the API.</p>

<p>Okay, I lied to you, this is actually not an operator of sorts, this is a simple
variable assignment to a variable called <code>_</code>. It&#39;s a neat little trick though to
make it obvious that you&#39;re not interested in a certain parameter. Also note
that <code>_</code> in irb references the value returned by the last expression executed.</p>

<p>You&#39;ll find it used in several places in the <a href="https://github.com/rack/rack/blob/0fbb575c1983980f621319650280a4dc8ba2af6c/lib/rack/utils.rb#L192-203">Rack source
code</a>.</p>

<h3>Tuple arguments</h3>

<p>This one blew my mind when I found it somewhere in the depths of Rack&#39;s source
(or somewhere else I don&#39;t remember). Think of a hash where each key points to
an array of things. Wouldn&#39;t it be nice if you could extract them all in one go
while iterating over them without having to first iterate over the hash and then
over the embedded arrays?</p>

<p>Turns out, the tuple operator is just what we need for this. This is an example
from a Chef cookbook I built a while back, specifying some thresholds for an
Apach configuration for Monit.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">apache_server_status = {
  waitlimit: [&quot;&lt;&quot;, &quot;10%&quot;],
  dnslimit: [&quot;&gt;&quot;, &quot;25%&quot;]
}

apache_server_status.each do |name, (operator, limit)|
  puts &quot;protocol apache-status #{name} #{operator} #{limit}&quot; 
end
</code></pre></div>
<p>Notice the definition of <code>(operator, limt)</code>. That little bead nicely extracts
the array with operator and a percentage in it into two parameters. Here&#39;s
another thing that blew my mind, chaining enumerators, collecting values and index
from a hash, for example. Note that hashes are sorted in Ruby 1.9, so this is a
perfectly valid thing to do.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">names = {username: &quot;roidrage&quot;, fullname: &quot;Mathias Meyer&quot;}
names.each.with_index do |(key, value), index|
  puts &quot;##{index}: #{key}:#{value}&quot;
end
</code></pre></div>
<p>Hat tip to <a href="http://twitter.com/Lenary">Sam Elliott</a> for blowing my mind with this.</p>

<h3>The end</h3>

<p>Know what the best part is? All this works with method calls too. The tuple
assignment, using <code>_</code> to ignore values, the splats, referencing previous
parameters.</p>

<p>Some of them even work for multiple variable assigmnents.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">_, *tail = [1, 2, 3]
name, (operator, limit) = [:waitlimit, [&quot;&lt;&quot;, &quot;10%&quot;]]
</code></pre></div>
<p>Crazy.</p>

    </div>
    <div class="item_meta">
      <div class="item_tags">Tags:
        
      </div>
      <div class="item_hierarchy">Hierarchy:
        
          <a href="/2012/1/30/a-tour-of-amazons-dynamodb.html" title="Previous post">previous</a>
        
        
        
          , <a href="/2012/2/28/february-reading-list.html" title="Next post">next</a>
        
        </div>
    </div>
  </div>
</article>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
