<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. Singing the Paypal Subscription Blues</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. Singing the Paypal Subscription Blues"/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
     
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Singing the Paypal Subscription Blues"/>
    <meta name="twitter:site" content="@roidrage"/>
    <meta name="twitter:creator" content="@roidrage"/>
    <meta name="twitter:description" content="For a recent project I had the pleasure to work with Paypal, especially with the Instant Payment Notification API. I haven&#39;t heard a lot of things before I tried to marry it with Rails, but wha..."/>
    <meta name="twitter:url" content="http://www.paperplanes.de/2007/11/27/singing_the_paypal_subscription_blues.html"/>
    <meta name="twitter:domain" content="paperplanes.de"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <article class="hentry">
  <div class="item_perma">
    <div class="item_details">
      <header>
        <h3 class="entry-title">Singing the Paypal Subscription Blues</h3>
        <h4><a href="/2007/11/27/singing_the_paypal_subscription_blues.html" title="Permalink for this post">27 November 2007</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </header>
    </div>
    <div class="item_content">
      <p>For a recent project I had the pleasure to work with Paypal, especially with the Instant Payment Notification API. I haven&#39;t heard a lot of things before I tried to marry it with Rails, but what I&#39;d heard made me assume it wouldn&#39;t be a piece of cake. And I was right.</p>

<p>I&#39;d love to share some code with you, but <a href="http://fortytwo.gr/">Vasillis Dimos</a> beat me to it. He wrote two posts on Paypal IPN and Rails, one dealing with <a href="http://fortytwo.gr/blog/14/Using-Paypal-with-Rails">the basics</a> and the other about <a href="http://fortytwo.gr/blog/17/Mock-testing-Paypal%27s-IPN-with-Rails">mocking IPN</a>, which you really need to do to test your code. Really.</p>

<p>Personally I did the testing a little differently, since all my payment handling logic was in the model. I didn&#39;t use <a href="http://www.activemerchant.org/">ActiveMerchant</a> either, but just the <a href="http://dist.leetsoft.com/api/paypal/">Paypal gem</a>. But in general things are similar. Outside of the US and the UK you&#39;re pretty much out of choices for payments, since there&#39;s no Web Payments Pro available here, so IPN is (sadly) the way to go. It&#39;s a real PITA and here&#39;s why:</p>

<ul>
<li>Paypal needs to reach your development machine from the outside. For testing this is not an issue of course, but when you need to do testing with the Paypal sandbox (which is painfully slow) and, god forbid, the real Paypal, there&#39;s no way around that.</li>
<li>The payment flow is unnatural. You have to handle the payment outside of the user&#39;s page flow. You have to rely solely on the stuff you get from Paypal, no session, no cookie, no user. It takes a lot of care to handle all that and there still might be a hole in your code that could be exploited.</li>
<li>IPNs might come in late, sometimes only after the user already got back to your site. Now you want to present him with a nice success message, but that&#39;s not gonna happen then. That&#39;s a rare case though. The IPN come in slower from the sandbox, that&#39;s for sure. It&#39;s up to you how to handle that. You can act in the favor of the user, or you can just make him wait till everything fell into place.</li>
<li>In rare cases you won&#39;t get an IPN from Paypal, for whatever reason. I&#39;ve seen this happen. Be prepared to create the successful payment by hand or have something like a small GUI at hand to do it.</li>
<li>For subscriptions six different notification types need to be handled. And their even spread out over two different fields in the notification.</li>
</ul>

<p>Some advice on how to get it right:
* Log everything. Store the IPNs in the database, in the log files, wherever. Just log them. Their your proof of things that happened. Just storing them with their raw post data should do while leaving the most important fields separately in different columns.
* Use mocks. It&#39;s not hard. But it&#39;s totally worth it. When you want to test all events that Paypal might send you, which is a lot for subscriptions, it&#39;s a painful development cycle. And some events aren&#39;t even fully testable by hand.
* Decide on strategy to handle fraud. While your IPN URL is not really public (nothing should link here, and it&#39;s hopefully transmitted to Paypal encrypted) it&#39;s not exactly safe to just accept everything.
* Don&#39;t return errors in your IPN handler. Paypal will try it again.
* Store a pending payment and make it a full one when the corresponding IPN arrives.</p>

<p>All that said, it was an experience, and while not always pleasant, at least I learned something. But Paypal is far from being a pleasant way to handle payments, if you want to make it secure and protect your the integrity of your application and prevent fraudulent users from abusing your services, all of which should be your primary interests.</p>

    </div>
    <div class="item_meta">
      <div class="item_tags">Tags:
        
      </div>
      <div class="item_hierarchy">Hierarchy:
        
          <a href="/2007/11/22/restful_leopard_spellcheck.html" title="Previous post">previous</a>
        
        
        
          , <a href="/2007/11/30/friday_links_301107.html" title="Next post">next</a>
        
        </div>
    </div>
  </div>
</article>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
