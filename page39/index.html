<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/5/18/railswaycon.html">RailsWayCon in Berlin</a></h3>
        <h4><a href="/2009/5/18/railswaycon.html" title="RailsWayCon in Berlin">18 May 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>Next week I&#39;ll attend and speak at the <a href="http://it-republik.de/conferences/railswaycon/">RailsWayCon</a> conference in Berlin. You can see <a href="http://it-republik.de/konferenzen/railswaycon/workshops/railswaycon/speaker/#3888">me</a> speak at the tutorial <a href="http://it-republik.de/konferenzen/railswaycon/workshops/">&quot;Deploying Rails Applications&quot;</a>, together with Jonathan Weiss, and talk about asynchronous processing in Rails applications. The <a href="http://it-republik.de/konferenzen/railswaycon/sessions/">line-up</a> looks pretty good. See you there!</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/4/20/a_ruby_meta_programming_riddle.html">A Ruby Meta-Programming Riddle</a></h3>
        <h4><a href="/2009/4/20/a_ruby_meta_programming_riddle.html" title="A Ruby Meta-Programming Riddle">20 April 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>When we were at Scotland on Rails (excellent conference by the way, you should definitely go), and we sat in Dave Thomas&#39; keynote, where he talked about the &quot;Ruby Object Model&quot;, funnily enough we ran across a meta-programming wonder in that very session. It has been keeping me busy for a couple of hours, and I&#39;d like to share my revelations. With some of them I&#39;m not completely in the clear, but maybe they&#39;ll be a start for discussion. It&#39;s more a tale of one of my adventure through the Ruby object model than a fancy tutorial, so if you&#39;re up for that kind of thing, keep going. If not, just keep on reading.</p>

<p>It all started with a simple piece of code which a friend borrowed from the CouchFoo plugin. The code is from a longer <a href="http://github.com/georgepalmer/couch_foo/blob/0f9317108cfdedbafecdcf1e97e35a2a5fcf30ad/lib/couch_foo/named_scope.rb">file</a>, but the basic gist of the original code looks like this:</p>

<script src="http://gist.github.com/97731.js"></script>

<p>The method <code>named_scope</code> is available as a singleton method on the including class. But that&#39;s the boring part, line 13 is where the action is. It&#39;s obvious what the code does, it fetches the singleton class of the current object, and defines a new singleton method on it using <code>define_method</code>, all that whilst being called on the class. Pretty straight forward so far, the context is pretty clear. But I was wondering, why on earth do you need to get the singleton class? Why not use define_method directly? After all, you&#39;re in the class object already. When that didn&#39;t work, I tried using <code>instance_eval</code> directly, calling it on the implicit self, since that must be the class, right?</p>

<p>We played around with a statement a little bit, and since it only worked in the way used above, it scratched my itch, and I tried all different combinations of declaring methods on the class that includes the module, and I also tried to find out where the different methods were defined in the hierarchy of modules, classes and singleton classes. Now, in terms of a normal object you&#39;re using in your code, that hierarchy is straight forward, okay not always, but you can always turn to Dave Thomas&#39; rule of going to the right and then up. But here we&#39;re talking about classes of classes, and that boggled my mind. It didn&#39;t even always help to go down the route Dave Thomas suggests, to ask yourself what self is in the context you&#39;re in.</p>

<p>There&#39;s different ways to get a singleton method onto the including class, not all of them suitable for dynamically creating methods, but still good to know where they go in the hierarchy.</p>

<p>Let me just go ahead and share the piece of code I ended up with to work through the problem:</p>

<script src="http://gist.github.com/87194.js"></script>

<p>As you can see I&#39;m defining the method <code>speak</code> on the including class <code>Matt</code> in five different ways. I turned to my good friend <code>super</code> as one way to find out where methods go into the hierarchy, and which ways of declaring methods overwrite others. The other way is simply to comment out method definitions and see how the resulting code works. I&#39;ve also added some basic tracing to see where the method is called from. You&#39;d think the <code>puts</code> is enough to follow the trace, but either it was already too late, or I&#39;m too stupid, but this way it just was easier for me to follow the method chain. It&#39;s been fun playing with this, and it still hurts my brain, so let&#39;s go through it as long as the pain&#39;s still there.</p>

<p>The principle is simple. The class <code>Matt</code> itself defines a singleton method called <code>speak</code>. Then it goes ahead and includes the module <code>Speech</code>. Don&#39;t worry about the two different modules <code>Speech</code> and <code>Speech::Support</code>, they&#39;re just for conciseness and could be easily removed, I just wanted to reproduce the way the code we were originally banging our heads on as good as possible. By extending the class with the module <code>ClassMethods</code> it puts that same module into the class hierarchy of the class <code>Matt</code>. That means, when the method <code>speak</code> is called Ruby will first look in the included module for the method. Since it finds it there it is simply executed. By calling <code>super</code> we can still reference the original method defined on the class, which also means that the method was not overwritten with this code. Simple enough.</p>

<p>When the code reaches <code>can_speak</code> the magic is about to unfold, and we&#39;re going through three different kinds of method definitions. Before we look at what happens in those, let&#39;s run this code and see what the output is:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">in 33 from /Volumes/Users/pom/Desktop/bla.rb:59
say: class &lt;&lt; self
in 18 from /Volumes/Users/pom/Desktop/bla.rb:35:in `speak&#39;
say: module method
in 41 from /Volumes/Users/pom/Desktop/bla.rb:20:in `speak&#39;
say: class.instance_eval
</code></pre></div>
<p>Okay, so only three of our five methods were actually called. Not too bad, but it still leaves questions unanswered. Commenting out some of the declarations will show you that all the definitions work on their own. That means that some declarations must overwrite others. Let&#39;s try and comment out the code in lines 24 to 29. You can believe me or try it yourself, but the output is still the same. What if we comment out lines 17 to 21:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">in 33 from /Volumes/Users/pom/Desktop/bla.rb:59
say: class &lt;&lt; self
in 41 from /Volumes/Users/pom/Desktop/bla.rb:35:in `speak&#39;
say: class.instance_eval
</code></pre></div>
<p>What? One less method being called? But shouldn&#39;t it have called the method defined directly on the class in line 50? What if we comment out lines 31 to 37:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">say: class_eval
in 18 from /Volumes/Users/pom/Desktop/bla.rb:27:in `speak&#39;
say: module method
in 41 from /Volumes/Users/pom/Desktop/bla.rb:20:in `speak&#39;
say: class.instance_eval
</code></pre></div>
<p>Aha, we&#39;re starting to see some progress. You can play around with all of them, I sure did for a while. Change the order of the definitions, but the gist will be the same in the end, believe me.</p>

<p>Okay, enough playing, let&#39;s look at the details. In <code>can_speak</code> we define three different methods, one using <code>class_eval</code>, one using <code>instance_eval</code> on the singleton class, and one using <code>instance_eval</code> directly on the class object. As you can see in the first output, only three methods were being called, the method defined on the module, the one using the singleton class and the last one using the class object. At this point it dawned on me what&#39;s happening here.</p>

<p>When the module is inserted into the hierarchy, it&#39;s put before the original class (which was <code>Matt</code>, in case you&#39;ve forgotten), the method <code>speak</code> in that class is not overwritten, but the module method will be found first during a lookup. But since we&#39;re defining a method on the singleton class of the class <code>Matt</code>, this one will be found before the module. The hierarchy order is singleton class, modules and then the original class, then the lookup continues through the superclasses. Fair enough, but where does that last method come in? It&#39;s the last in the chain which means that it&#39;s above the module&#39;s method.</p>

<p>I&#39;m not exactly sure what happens here, I&#39;m guessing that the code is being run directly on the class object, and not on its singleton class. If that&#39;s not the case that would basically mean that Ruby would insert another singleton class between the module and the class, but I don&#39;t think that&#39;s the case. If you have any pointer to clear things up, please add them as a comment.</p>

<p>The method definition using <code>class &lt;&lt; self</code> on the other hand, definitely works its magic on the singleton class. It overwrites a method that might&#39;ve been declared before which includes the method defined using <code>class_eval</code> in line 24. Both work below the level of the module which means that they must be working on the singleton class of class <code>Matt</code>. This is all based on a mixture of conjecture and output evaluation, so feel free to call bullshit on me, and correct me if I&#39;m wrong.</p>

<p>Now, to get back to the original question, why doesn&#39;t just using <code>define_method</code> work? <code>define_method</code> is a tricky fella, it always works on the implicit self which is the class <code>Matt</code>, even if you use <code>instance_eval</code> or <code>class_eval</code> on the implicit self. The result will be the same in both cases: An instance method for objects of the class <code>Matt</code>. Thanks to Jay Fields for <a href="http://blog.jayfields.com/2007/03/ruby-instanceeval-and-classeval-method.html">writing about this</a> (two years ago already, but still)</p>

<p>Also, why couldn&#39;t we just use <code>instance_eval</code> from within the context of the method <code>can_speak</code>? Did you just read the last paragraph? It answered the question already. But to go into a bit more detail, you need to call instance_eval on an explicit class object or its singleton class, and not within the context of the class itself. It&#39;s mind-boggling, but true.</p>

<p>The irony in all this? I banged my head on this for quite a while, but in the end the simple Dave Thomas example of looking at method lookups applies: Go one to the right, and then go up. It&#39;s harder to imagine this with just classes, but in they end it&#39;s the same, because everything in Ruby is an object, you didn&#39;t forget that, did you? You just need to figure out where the methods go when you go up. All this started when he was talking about the Ruby object model, and it ends with the very same. Funny like that.</p>

<p>Please, do yourself a favor and watch Dave Thomas&#39; [screencasts on the Ruby Object Model]. I tend to avoid meta-programming magic as much as I can, but it&#39;s still an excellent way to learn more about Ruby&#39;s internal workings. The screencasts sure helped me a lot.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/4/16/ruby_19_upgrading_woes.html">Ruby 1.9 Upgrading Woes</a></h3>
        <h4><a href="/2009/4/16/ruby_19_upgrading_woes.html" title="Ruby 1.9 Upgrading Woes">16 April 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>Actually, not so much woes, as general musings. I just finished upgrading a project I&#39;ve been maintaining for the last 15 months or so to Ruby 1.9, and I thought I&#39;d share some of my experiences with the process. Looking back it wasn&#39;t so hard after all, but there were some pitfalls.</p>

<h3>General</h3>

<p>In general the code base is not too big, and there were only some minor issues that needed to be taken care of, some syntactical changes were required, and that was pretty much it.</p>

<p>The biggest problems you&#39;re likely to run across are outdated libraries or gems you&#39;re using. A while ago mocha didn&#39;t fully support the new mini-test included in Ruby 1.9, but since version 0.9.5 it runs fine. I also had to upgrade Machinist, but these are just minor issues.</p>

<p>The site runs on Passenger, so the most recent version was in order, and it works like a charm.</p>

<p>I have yet to delve into potential encoding issues, since Ruby 1.9 complained about some characters in several strings, but the new encoding header should solve these no problem.</p>

<h3>MySQL</h3>

<p>The biggest headscratcher, but just for a second. The official <a href="http://www.tmtm.org/en/mysql/ruby/">MySQL gem</a> has received several updates, and the most recent version (2.8.1) runs just fine on Ruby 1.9, but unfortunately it&#39;s not available as a gem for convenient installation using the gem command. Thankfully Makoto Kuwata has stepped up and provides a nice gem on <a href="http://github.com/kwatch/mysql-ruby/tree/master">GitHub</a>. Install using <code>gem install kwatch-mysql-ruby -s http://gems.github.com</code>, and you&#39;re good to go.</p>

<p>Of course, for the future, the obvious choice should be to use the <a href="http://github.com/espace/mysqlplus/tree/master">MySQL Plus driver</a> <a href="http://www.espace.com.eg/neverblock/blog/2008/08/28/neverblock-mysql-support/">powered by Neverblock</a>.</p>

<h3>RSpec</h3>

<p>The specs didn&#39;t run at all for a starters, but that was due to the wrong test-unit gem being installed. Make sure you have version 1.2.3 installed, then the specs run no problem. Be sure to use the latest versions of the rspec and rspec-rails gems. RSpec has a <a href="http://wiki.github.com/dchelimsky/rspec/ruby-191">small wiki page</a> dedicated to Ruby 1.9.1, so be sure to keep an eye on that.</p>

<h3>Cucumber</h3>

<p>Cucumber had similar problems, it requires a class that only exists in the test-unit gem, so you definitely need to install that anyway. The features ran almost from the get-go, but there was on problem with date selects and webrat. When I didn&#39;t explicitly select a date, it would hand over weird array constructs to the controller, which in turn resulted in assignment errors from within ActiveRecord. The solution (for now) was to explicitly specify the date I wanted, but I&#39;d much prefer being able to leave the defaults as they are.</p>

<h3>NewRelic</h3>

<p>The RPM plugin references a method in Ruby&#39;s Thread class that are no longer available in Ruby 1.9. I had to manually remove the calls in the plugin to get it to work. All the changes are in <code>lib/new_relic/agent/instrumentation/dispatcher_instrumentation</code>. Look for <code>Thread.critical</code> and removed its usages. I have yet to find out if that in any way affects the plugin, but for now it&#39;ll have to do.</p>

<p>And yes, that was it for me. At least on that specific project. To sum up, I spent about two hours fixing the issues, and now, on Ruby 1.9, my full test suite is running about 30 seconds faster than on Ruby 1.8. Totally worth it, if you ask me.</p>

<p>The full results:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">1.8: rake spec features  68.72s user 4.03s system 91% cpu 1:19.89 total
1.9: rake1.9 spec features  39.95s user 2.39s system 84% cpu 49.975 total
</code></pre></div>
<p>I&#39;ll be sure to try and use Ruby 1.9 for all upcoming projects. The speed gain alone justifies it for me.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page38" class="previous">Newer Posts</a>
    
  
  
    <a href="/page40" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
