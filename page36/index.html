<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/10/19/the_shoulda_rspec_extravaganza.html">The Shoulda RSpec Extravaganza</a></h3>
        <h4><a href="/2009/10/19/the_shoulda_rspec_extravaganza.html" title="The Shoulda RSpec Extravaganza">19 October 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>I don&#39;t use RSpec a lot any more these days. I much prefer Shoulda, heck I even started using Rails integration tests again (using Shoulda of course), because sometimes the additional abstraction of Cucumber is just too much. Any way, there&#39;s some things I liked about RSpec, and they were not related to the features of the testing DSL itself, but more to the tool RSpec. It has a neat formatter that&#39;ll output the ten slowest-running tests. I also found the colored list of full test names to be very helpful.</p>

<p>So I scratched my itch last weekend and brought that goodness to Shoulda. Our test suite is starting to get a bit slow, and it already served us well to find the slowest one. I like the approach of rinse and repeat to squeeze some valueable dozens of seconds out of a test suite with that technique.</p>

<p>So without further ado, I give you shoulda-addons, my little patch set to bring both test profiling and a colored list of full test names to you Shoulda test suite. I&#39;m sure it&#39;d work with normal Test::Unit or MiniTest without much effort, but for now it&#39;s made for Shoulda, and it looks like this:</p>

<p><img src="http://img.skitch.com/20091019-m5wema3px8e7asmcqnjynq6ib.jpg" alt="Screen shot 2009-10-19 at 22.11.07" width="530"/></p>

<p>While adding in the profiling was pretty straight forward, getting the colored output was pretty messy, and I&#39;m not proud of it, especially considering that Test::Unit and MiniTest go different routes of outputting the little dots F&#39;s and E&#39;s.</p>

<p>The package is up on <a href="http://github.com/mattmatt/shoulda-addons">GitHub</a>, can be installed from <a href="http://www.gemcutter.org">Gemcutter</a> via <code>gem install shoulda-addons</code>, and should work with Ruby 1.8 and 1.9. I also tested it with Mocha included, so let me know if something doesn&#39;t work for you.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/9/25/how_not_to_design_an_api.html">How Not To Design An API</a></h3>
        <h4><a href="/2009/9/25/how_not_to_design_an_api.html" title="How Not To Design An API">25 September 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>I&#39;ve had the dubious pleasure of working with a certain library. It&#39;s a layer to talk to most of the Amazon Web Services APIs. While working with web services usually is a particular awful experience, this library doesn&#39;t make much of an effort to hide their awkwardness, in fact, in some ways it even makes it worse. It&#39;s pretty old news that I enjoy bitching about code I don&#39;t like, but I also like to keep it positive in at least thinking about how it could be improved.</p>

<p>Let&#39;s take a moment and have a look at what part of their API is particularly nasty and how the situation could be improved. We actually wrote a micro-wrapper around that library to make things a bit less awful for us, and to at least keep their code out of ours.</p>

<p>I&#39;m looking in particular at the EC2 part of the library. Here&#39;s the signature of the method that runs a new instance:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">run_instances(image_id, min_count, max_count, group_ids, key_name,
              user_data=&#39;&#39;, addressing_type = nil, instance_type = nil,
              kernel_id = nil, ramdisk_id = nil, availability_zone = nil,
              block_device_mappings = nil)
</code></pre></div>
<p>Yes, that&#39;s 12 arguments you can hand over to the method, most of them being optional. Now, what&#39;s it look like calling it:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">run_instances(&#39;ami-123445&#39;, 1, 1, [], &#39;default&#39;)
</code></pre></div>
<p>So far so good. But what if you want to specify a different availability zone for e.g. the EU:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">run_instances(&#39;ami-123445&#39;, 1, 1, [], &#39;default&#39;, &#39;&#39;, nil, nil, nil, nil, &#39;eu-west1b&#39;)
</code></pre></div>
<p>Nice, eh? It&#39;s starting to get really ugly. The important parameters are hidden by unnecessary noise. What&#39;s with <code>max_count</code> and <code>min_count</code> not having default values? I&#39;d argue that you normally it&#39;d be quite reasonable to assume that you only want to run one instance when calling the method without these two parameters.</p>

<p>Anyway, that&#39;s just one example, in general, there&#39;s only one important piece of information, and that&#39;s the AMI identifier. Let&#39;s look at what this method could look like when you sprinkle some very common Rubyisms on top, things that should be quite common sense when writing code in Ruby, but seem to have been lost here in favor of resembling the original API as close as possible, even if that means writing cumbersome code:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">run_instance(&#39;ami-123445&#39;, :availability_zone =&gt; &#39;eu-west1b&#39;, :ssh_key =&gt; &#39;default&#39;)
</code></pre></div>
<p>Now the method only takes one argument and a has of options. Is it more code to write? Yes. Are its intentions clearer? I&#39;d argue that they are. Is it close to what the API underneath expects as arguments? Closer than before. Unnecessary information is left out, because either the method itself could send sensible defaults, or the web service itself does it. The EC2 API even has a default for the instance type, and it doesn&#39;t care if you leave out the RAM disk or specific kernel. It does what&#39;s necessary to ensure your instance is up.</p>

<p>Knowing that, it&#39;s not that hard to hide those details behind a slightly improved version of <code>run_instances</code>, in this case even called <code>run_instance</code>. Throw in a method <code>run_instances</code> to handle specifics of launching multiple instances at once. Is it more code to write? Sure. But it sure as hell makes for a nicer usage of the library itself. Instead of having to look up the order of the method&#39;s parameters and fill in blanks with nil, I only have to look what options the methods accepts.</p>

<p>In general I don&#39;t like giving a method more than three arguments. It simply means it&#39;s doing too much, or that the data it needs should be wrapped in a simple data structure, e.g. a hash (which is just called for in Ruby) or a simple struct. The more arguments you give a method, the harder it will be for users to figure out its usage, especially if you make a whole stash of them optional, because then the order of them starts to matter, and users have to dig through an endless line of documentation just to figure out where the argument most important to them needs to be placed among a pile of nils.</p>

<p><code>run_instances</code> in said library returns an array of hashes. Those hashes contain the data returned by the web service, each entry in the array describing one instance. Apart from the fact that you always have to get the first entry of that array when you just launched one instance, it also does something weird. EC2 returns attributes in the hash using names like imageId, instanceId, keyName and so on. You could argue about the naming style, but the names sure are reasonable. What <code>run_instances</code> does is go ahead and prefix almost every attribute with <code>aws_</code>, but not all of them. Most methods in said library do the same, so at least there&#39;s some consistency, but it sure isn&#39;t great.</p>

<p>So while trying to resemble the API call, it makes you care about what&#39;s what instead of just giving you the attributes as it receives them from the API. The answer to this is simple, give me the damn attributes as you get them, simple like that. If you need to ensure that there are no naming clashes, put them in a subhash e.g. using the key <code>:ec2</code> if you must.</p>

<p>Another example is this really simple method:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">describe_instances(list=[])
</code></pre></div>
<p>It takes an array as an argument, but nothing more. Even if you just want to get the data for one instance, you have to call it like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">describe_instances([&#39;i-123454&#39;])
</code></pre></div>
<p>I don&#39;t know about you, but I think that looks just gross. We&#39;re using Ruby for chrissakes, there&#39;s a simple mechanism to ensure you get an array, but the library user doesn&#39;t need to specify it as such, it&#39;s called splat arguments. It&#39;s a simple fix, and has great effect.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">describe_instances(&#39;i-123454&#39;, &#39;i-213143&#39;)
</code></pre></div>
<p>There, much better. Again, I&#39;d make the case for a convenience method for getting the data for just one instance, which in turn fetches the first element from the resulting array. If you must, generate the code for it, but it makes code using the library a lot easier on the eyes. Sure, it&#39;s more work for you as the library&#39;s author, but your users will be thankful, I&#39;m sure.</p>

<p>Last example, the library&#39;s layer to access S3. Now, when I reach for my bucket, I can use this method:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bucket(name, create=false, perms=nil, headers={})
</code></pre></div>
<p>The second parameter caught my eye, according to the RDoc it creates the bucket if it doesn&#39;t exist. Looking at the code it just doesn&#39;t even check if the bucket already exists, it just goes ahead and does a PUT request whenever you specify true. So to make the intention clearer you actually have to do the checking yourself and recall the method with <code>create</code> set to true to create the bucket on the second run. Because if it doesn&#39;t exist <code>bucket</code> will just return nil. You could end up with something like this.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bucket(&#39;bucket-for-monsieur&#39;) or bucket(&#39;bucket-for-monsieur&#39;, true)
</code></pre></div>
<p>So the RDoc is actually lying to us, and we have to bend over and ruin one line of code just because our library is too lazy to do the job for us. If you ask me, the whole method signature looks a bit odd. Somehow it also calls for a little makeover with an options hash, and it obviously should do what it says and check the existence of the bucket for us if we ask it to, and maybe raise an error otherwise, but the latter is a matter of taste. Sometimes I&#39;d rather like to have an error instead of having to check for nil, since in this case you could argue that it clearly is an exceptional situation.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">bucket(&#39;bucket-for-monsieur&#39;, :create =&gt; true, :permissions =&gt; &#39;public&#39;)
</code></pre></div>
<p>Designing a good API is hard, especially when you&#39;re hiding one that&#39;s already not great, though that&#39;s not an excuse. But sometimes it&#39;s well worth looking at how you think others would want to use your library, putting aside the fact that you need to do more work maybe to make it more usable. It&#39;s not too much to ask, and it&#39;ll sure make your users happy, because their code will look nicer too. The only failure I could add to the above is when the methods would have the real names of the API calls:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">DescribeInstances([&#39;i-123454&#39;])
</code></pre></div>
<p>Gross! You can laugh now, but some Ruby libraries for accessing Amazon&#39;s Web Services don&#39;t shy away from exposing you to these undoubtedly not Ruby-like method names.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/9/8/the_nosql_dilemma.html">The NoSQL Dilemma (with a Happy Ending)</a></h3>
        <h4><a href="/2009/9/8/the_nosql_dilemma.html" title="The NoSQL Dilemma (with a Happy Ending)">08 September 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>Call it <a href="http://voodootikigod.com/nosql-a-modest-proposal">NoSQL</a>, call it <a href="http://therealadam.com/archive/2009/08/31/its-not-nosql-its-post-relational/">post-relational</a>, call it what you like, but it&#39;s hard to ignore that hings are happening in the database world. A paradigm shift is not too far ahead, and it&#39;s a big one, and I for one am welcoming our post-relational overlords. Whatever you call them, <a href="http://couchdb.apache.org/">CouchDB</a>, <a href="http://www.mongodb.org/">MongoDB</a> (although you really shouldn&#39;t call a database MongoDB), <a href="http://incubator.apache.org/cassandra/">Cassandra</a>, <a href="http://code.google.com/p/redis/">Redis</a>, <a href="http://1978th.net/tokyocabinet/">Tokyo Cabinet</a>, etc. I&#39;m well aware that they&#39;re not necessarily all the same, but they do try to fill similar gaps. Making data storage easy as pie, offering data storage fitting with the kind of evolving data we usually find on the web.</p>

<p>The web is slowly moving away from relational databases and with that, SQL. Let me just say it upfront: I hate SQL. I physically hate it. It doesn&#39;t fit with my way of thinking about problems, and it doesn&#39;t fit with the web. That&#39;s my opinion anyway, but I&#39;m sure I&#39;m not alone with it.</p>

<p>There is however one area where object-oriented databases failed, and where the new generation of document databases will have similar problems. You could argue that object-oriented databases are in some way a predecessor to modern post-relational databases, they made storing objects insanely easy, no matter how complex they were, and they made navigating through objects trees even easier and insanely fast. Which made them applicable to some problems, but they weren&#39;t flexible enough in my opinion. But they still laid some groundwork.</p>

<div style="width:100%; text-align:center">
<img src="http://img.skitch.com/20090908-cmhe5mk953kst1je4kji3qub2p.jpg" alt="skitched-20090908-165230.jpg"/>
</div>

<p>It&#39;s mainly concerning The Enterprise and their giant collection of reporting tools. Everybody loves tools, and The Enterprise especially loves them. The more expensive, the better. Reporting tools are the base for those awesome pie charts they just love to fill entire PowerPoint presentations with. They work on &quot;standardized&quot; interfaces and languages and therefore, with SQL.</p>

<p>I&#39;ve worked on a project were we switched from an object-oriented to a relational database just because of that. Sure, there&#39;s proprietary query languages, or there&#39;s JQL when you&#39;re into JDO, EJB3 and the like. But they&#39;re nowhere as powerful as SQL is. They&#39;re also not as brain-twisting. That should be a good thing really, but there you have it.</p>

<p>NoSQL databases are facing a similar dilemma. Just like object-oriented databases they&#39;re awesome for just dumping data in it, more or less structured. It&#39;s easy to get them out too, and it&#39;s usually easy to aggregate the data in some way. Is it a big deal? Of course not, at least not in my opinion. But if it is some sort of deal, what can you do to work around that?</p>

<ul>
<li><p>Ignore it. Simple, isn&#39;t it? The reporting requirement can usually be solved in a different way. Sure, it can be more work, but usually reporting is less of a killer than some might think. Give the client some way to express a query and let him at it. Give him a spare instance of your replicated database, and let him work off that data. Best thing you could do is pre-aggregate it as much as possible so there&#39;s less work for the client.</p></li>
<li><p>If you really need structured data in a relational database, consider replicating the data into one from your post-relational database of choice. I can hear you say: That guy&#39;s crazy, that&#39;d involve so much work keeping the two in sync! No, it wouldn&#39;t. Create a fresh dump every time you need a current dataset, and dump it into your SQL database. Simple like that.</p></li>
<li><p>Put an interface in front of the new database. Yes, it&#39;s insane, but I&#39;ve done it, and it works. It doesn&#39;t have to be an SQL interface, just a common interface that works with one set of reporting tools. Yes, it&#39;s not ideal, but it&#39;s an option.</p></li>
<li><p>Don&#39;t ignore it, keep using a relational database. Yep, not all of us are lucky enough, someone still has to serve the market demands. Legacy projects or clients are forcing us to stick with the old and the dusty model of storing and retrieving data. Quite a lot of people are happy with that, but I&#39;m not.</p></li>
</ul>

<p>I&#39;m sure there&#39;s other options, these are just off the top of my head, and I can say that I&#39;ve practiced all of them with more or less good results.. I for one am sick of still having to use MySQL on new projects. I&#39;ve had my fun with it, and sure there&#39;s a whole bunch of patches that make it a bit more fun, but it&#39;s still MySQL. Yes, I am aware that there&#39;s PostgreSQL, but it&#39;s the same story. Old, old and old.</p>

<p>Should you still try to get a new generation database into new projects? Yes, yes and yes, you definitely should. Consider yourself lucky if you succeed, because you&#39;re still an early awesome adopter. Even use SimpleDB if you must, but maybe reconsider before you really use it, it&#39;s not great. But don&#39;t lie to your clients, they should be aware what they&#39;re getting into. It&#39;s no big deal, but the bigger they are the more likely they have administrators not yet familiar with the new tools. But the more people start using them now, the better they&#39;ll get before they hit the mainstream. Which they will eventually, rest assured. I&#39;m ready, the web is ready, and the tools are ready. What about you?</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page35" class="previous">Newer Posts</a>
    
  
  
    <a href="/page37" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
