<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/3/22/xray_goggles_for_your_ruby_processes.html">XRay Goggles For Your Ruby Processes</a></h3>
        <h4><a href="/2009/3/22/xray_goggles_for_your_ruby_processes.html" title="XRay Goggles For Your Ruby Processes">22 March 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>The guys over at <a href="http://pivotallabs.com/">Pivotal Labs</a> wrote a <a href="http://pivotallabs.com/users/steve/blog/articles/746-inspect-running-ruby-processes-using-xray-and-kill-3">small piece</a> on a neat tool called <a href="http://xray.rubyforge.org/">XRay</a>. It hooks into your Ruby code to provide Java-like signal handlers which dump the current stack trace into whatever log file seems fit. Using Passenger that&#39;ll be your Apache&#39;s error log file.</p>

<p>Say what you want about Java and it&#39;s enterprisey bloated-ness, but some features of it come in quite handy, especially when they allow looking into your processes without immediately having to turn to tools like NewRelic or FiveRuns.</p>

<p>Just add the following line to your application.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &quot;xray/thread_dump_signal_handler&quot;
</code></pre></div>
<p>From then on you can use <code>kill -QUIT &lt;pid&gt;</code> to get a trace dump in your log file. Neat! The website says you need to patch Ruby, but for me it worked with the Ruby that comes with Leopard, and Ruby Enterprise Edition.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/3/19/parallizing_capistrano.html">Parallelizing Capistrano</a></h3>
        <h4><a href="/2009/3/19/parallizing_capistrano.html" title="Parallelizing Capistrano">19 March 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>On a recent project we ran into a situation where we needed a more advanced way of parallelizing Capistrano tasks than just using the parallel method it already sports. To jog your memory, parallel can run arbitrary shell commands in parallel on different servers. So if you wanted your webserver to already restart the processes while you restart your background processes, you can do it like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallel do |session|
  session.when &#39;in?(:web)&#39;, &#39;script/spin&#39;
  session.when &#39;in?(:daemon)&#39;, &#39;script/daemons restart&#39;
end
</code></pre></div>
<p>You can even use it to run tasks in parallel on the same hosts, but it looks ugly, and it only works for shell commands. So we came up with a neat extension that lets you run arbitrary blocks of code in parallel. Obviously you&#39;d usually call tasks in those blocks, but who knows. Let&#39;s just have a look at an example.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallelize do |session|
  session.run { deploy.restart }
  session.run { daemons.restart }
end
</code></pre></div>
<p>Neat! We&#39;re aware that the name might not be perfect, suggestions welcome, but for now it&#39;ll do. What it does is run each block in a different thread. Due to some internal Capistrano limitations it also opens a new SSH session for each thread. That&#39;s a bit of a bummer, but we&#39;d have to rework a lot of the command code of Capistrano to get that to work with multiple threads. It also means that you should usually limit the amount of tasks you run at any one time, but thankfully you can either do that by setting the <code>parallelize_thread_count</code> variable. It defaults to ten concurrent thread. parallelize will run all the blocks in chunks corresponding to that size, and will only run the next chunk when all blocks in the first finished successfully.</p>

<p>You can also hand in the chunk size directly, since it sometimes just doesn&#39;t make sense to run as many tasks in one go as possible, especially when they&#39;re run on just one host. It might just take longer to run them all in parallel than to ran two batches one after the other. So it&#39;s easy to specify the chunk size for specific tasks.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">parallelize(5) do
  session.run { deploy.restart }
  session.run { daemons.restart }
end
</code></pre></div>
<p>If one of the tasks in the specified blocks causes a rollback or raises an error, then parallelize will run the rollback on all the other threads and on the main thread. Now, in general I wouldn&#39;t recommend running too many tasks in parallel that require big rollback procedures, but just in case you&#39;re into that sort of thing, knock yourself out.</p>

<p>We could see a considerable improvement in deployment speed, especially during the time-critical tasks. The project is up on <a href="http://github.com/mattmatt/cap-ext-parallelize">GitHub</a>, and it might just be moved into the capistrano-ext module in the future. Install using</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">gem install mattmatt-cap-ext-parallelize -s http://gems.github.com
</code></pre></div>
<p>And then in your Capfile, insert this line</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;cap_ext_parallelize&#39;
</code></pre></div>
<p>Let <a href="mailto:capistrano@peritor.com">us</a> know if you have any problems.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2009/3/18/mocking_is_so_2008.html">Mocking Is So 2008</a></h3>
        <h4><a href="/2009/3/18/mocking_is_so_2008.html" title="Mocking Is So 2008">18 March 2009</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>Pat Maddox recently published a blog post on mocking called <a href="http://www.patmaddox.com/blog/you-probably-dont-get-mocks">&quot;You Probably Don&#39;t Get Mocks.&quot;</a> I wanted to write something on my experiences with mocks for a while now, so here&#39;s good reason to finally do so. I&#39;m a recovering mock addict, if you will, so this is my retribution of things I learned over the last 18 months, and how my testing workflow changed with them.</p>

<p>When you dive into RSpec, mocking will be put in your face right from the start. For some it might even be the thing that makes BDD what it is, testing how your code behaves. I followed that path for about a year. I wouldn&#39;t say religiously, but I did use it wherever it made sense. The project started out with no tests at all, so mocking actually did come in handy for some of the bigger controllers, in the beginning, that is. It also made the whole test suite rather speedy. When I was finished with the project, it had about 2200 specs which took less than two minutes. A good run still, certainly with room to improve performance.</p>

<p>But towards the end some things changed, my testing workflow changed. Pat might argue that I probably don&#39;t get mocks, but the tests felt brittle. That&#39;s not all the mocks&#39; fault, the code still was very brittle in some areas, so the tests had to do quite a lot to get a decent setup. It just didn&#39;t feel right to use mocks for controller tests.</p>

<p>These days I use Cucumber to do full-stack testing, so for one I agree with Pat. If you have a decent acceptance test suite, the brittleness mocks and stubs bring into your code gets less annoying. But in all that got me thinking. If I need integration tests to secure that my mocks still do what they&#39;re supposed to, something isn&#39;t right. On said project I only had a good suite of controller and unit tests (yeah, their specs, I know, I&#39;m not religious about the name, in the end they all test the code), so I had to rely on the tests to give good and reliable results, at least on that level.</p>

<h3>Write Code That Doesn&#39;t Suck</h3>

<p>When I watched Yehuda Katz&#39; <a href="http://rubyconf2008.confreaks.com/writing-code-that-doesnt-suck.html">talk at RubyConf 2008</a>, it hit me. Who cares what your controller does on the inside, how it get things done? Does it really matter? Is that a defined business value? No, because what matters is what comes out in the end, what the user sees. I also watched the talk called <a href="http://rubyconf2008.confreaks.com/testing-heresies.html">&quot;Testing Heresies&quot;</a> that Pat mentions, but here I agree with Pat, it was not at all convincing. But for me, Yehuda&#39;s talk hit right home.</p>

<p>It pretty much was that realization that made me testing framework agnostic. It just doesn&#39;t matter to me what you&#39;re using to write tests, as long as you write them, and as long as they&#39;re a reliable base for working with your code. Sure I appreciate RSpec&#39;s syntax and it trying to embrace BDD to the fullest, but in the end, it just doesn&#39;t matter. If you don&#39;t care about all the glory internal details of a test, then it doesn&#39;t matter if you use a fancy should syntax or plain old Test::Unit tests.</p>

<p>With Cucumber, the question for me is: If I have a decent acceptance test suite, then what do I need to do big testing on the controller level for? The acceptance test suite should cover most of what the controller does anyway. I started using resource_controller a while ago, and it takes away a lot of the &quot;complexity&quot; you usually have in your controllers. It reduces the controllers to what models in the Java world used to be: Dumb classes, and therefore reduces the amount of testing code for controllers. While that feels right to me, you could still argue that mocks and stubs make sense to test those cases where you still write tests on the controller level. Sure, but even in these cases I&#39;d rather rely on real data, even if that&#39;ll slow down my test suite. The slowdown can&#39;t be that bad, if it is, then your controllers are simply doing too much.</p>

<h3>Mocks Don&#39;t Fix Slow Tests</h3>

<p>Jon Dahl recently posted a post on <a href="http://railspikes.com/2009/3/10/slow-tests-are-a-bug">slow tests being a bug</a>. Interestingly he didn&#39;t mention mocks or stubs as a measure to speed up tests. Maybe he forgot, but to me that&#39;s pretty interesting. It used to be an compelling reason to use mocks for me, but these days I&#39;d rather have a slower test suite, but one that&#39;s more reliable. Using mocks to speed up your tests is just wrong, you exchange reliability for speed. Call me paranoid, but that doesn&#39;t seem right to me.</p>

<p>The isolation of controller and model for me just is a no-brainer. Whether you like it or not, the controller doesn&#39;t work without the model. Even stubbing out the model doesn&#39;t hide that fact. I embrace it, and by keeping my controller as small as possible, using a tiny abstraction like resource_controller and factories for test data, I just don&#39;t care about using mocks anymore. It gives me a much better sense of safety. If you get mocks or not, that&#39;s what it boils down to. If you feel like mocks give you a false sense of security, stop using them, if you&#39;re comfortable with them, for the love of BDD, keep using them, but don&#39;t expect me to use them when I&#39;m writing tests.</p>

<p>All that said, there is still one good reason to use mocks and stubs for me. It&#39;s to stub out external services. So yeah, if you want to say that I probably don&#39;t get mocks, feel free. Personally I just feel a lot more comfortable without them, and to me that&#39;s way more important. Keep your controller tests as small as possible, and the whole reasoning for mocks and stubs vanishes. Mocks dumb down your tests, and that&#39;s exactly what should not happen under any circumstances. If anything needs to know all the facts about a piece of code under test, it should be the tests themselves.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page40" class="previous">Newer Posts</a>
    
  
  
    <a href="/page42" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
