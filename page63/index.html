<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2008/2/18/how_to_process_multiple_activemessaging.html">How to Process Multiple ActiveMessaging Queues Concurrently</a></h3>
        <h4><a href="/2008/2/18/how_to_process_multiple_activemessaging.html" title="How to Process Multiple ActiveMessaging Queues Concurrently">18 February 2008</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>The title totally overemphasizes the topic, but here we go. By default <a href="http://code.google.com/p/activemessaging/">ActiveMessaging</a> will process all your queues in one thread. All messages from all queues will be processes sequentially. This isn&#39;t always what you want. Especially in scenarios where you have both long-running tasks being kicked off through messages, and rather short-lived tasks that you just fire and forget.</p>

<p>ActiveMessaging has a rather simple and not-so-obvious way of dealing with that: processor groups. There&#39;s some <a href="http://code.google.com/p/activemessaging/wiki/Configuration">documentation</a> on them, but it doesn&#39;t bring out the real beauty of them.</p>

<p>Basically you split your processors in groups, how finely grained is up to you. A simple way would be to just separate long-running from short-lived tasks. You just have to define these in <code>config/messaging.rb</code>:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">ActiveMessaging::Gateway.define do |s|
  s.destination :index_update, &#39;/queue/IndexUpdate&#39;
  s.destination :giant_batch_job, &#39;/queue/GiantBatchJob&#39;
  s.processor_group :short, :index_update_processor
  s.processor_group :long, :giant_batch_job_processor
end
</code></pre></div>
<p>Now that you have these, how do you get them to run in different threads? If you just use <code>script/poller start</code>, it will continue to work through all messages from all queues. You need to start each processor group individually:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ script/poller start ---- process-group=short
$ script/poller start ---- process-group=long
</code></pre></div>
<p>Keep in mind though that you can&#39;t stop just one poller for one particular processor group. Running <code>script/poller stop</code> will tear them all down. Which comes in handy during deployments. That way you only have to ensure that all your process groups are started during the deployment, but not about stopping every one of them.</p>

<p>ActiveMessaging will run each group in a separate thread which all are monitored by the poller_monitor. The latter will only be started once, courtesy of the <a href="http://daemons.rubyforge.org/">daemons</a> package.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2008/2/15/amazon_s3_is_down.html">Amazon S3 is Down</a></h3>
        <h4><a href="/2008/2/15/amazon_s3_is_down.html" title="Amazon S3 is Down">15 February 2008</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>And if you listen really carefully, you can hear thousands of Web 2.0 companies screaming. Strangely enough, uploads are running almost smoothly.</p>

<p>Update: And we&#39;re back on ;)</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2008/2/14/serializing_data_with_activemessaging_and.html">Serializing Data with ActiveMessaging and Filters</a></h3>
        <h4><a href="/2008/2/14/serializing_data_with_activemessaging_and.html" title="Serializing Data with ActiveMessaging and Filters">14 February 2008</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>I&#39;ve been playing around with <a href="http://code.google.com/p/activemessaging/">ActiveMessaging</a> recently. Well, actually more than that. I integrated it into a project for asynchronous processing. It&#39;s a pretty neat plugin. We&#39;re using <a href="http://stompserver.rubyforge.org/">StompServer</a> as a message broker, and therefore the <a href="http://stomp.codehaus.org/">Stomp</a> protocol to publish and poll the messages.</p>

<p>Now Stomp is a pretty simple protocol and breaks down when you&#39;re trying to deliver &quot;complex&quot; data structures like hashes, arrays or *<strong><em>gasp</em></strong>* objects. That&#39;s not a bad thing per se, since we can serialize them with YAML. Of course you could just always do that by hand before publishing a message, but let&#39;s face it, that&#39;s just tedious.</p>

<p>The author of ActiveMessaging <a href="http://groups.google.com/group/activemessaging-discuss/browse_thread/thread/e68fddae16a965c6">recently added support for filters</a>. They can be run after publishing a message and/or before processing it on the polling side. I hear it clicking on your end, why not use filters to do the serializing work for us? Right on!</p>

<p>Here&#39;s a simple filter to serialize the message when it&#39;s sent:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">class SerializeToYamlFilter &lt; ActiveMessaging::Filter
  attr_accessor :options

  def initialize(options={})
    @options = options
  end

  def process(message, routing)
    if message.body.respond_to?(:to_yaml)
      message.body = message.body.to_yaml
    else
      message.body = YAML::dump(message.body)
    end
  end
end
</code></pre></div>
<p>It uses the <code>to_yaml</code> method mixed in by Rails, if it&#39;s available. Otherwise it just dumps the object with the <code>YAML::dump</code> method.</p>

<p>The receiving end is even easier.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">class DeserializeYamlFilter &lt; ActiveMessaging::Filter
  attr_accessor :options

  def initialize(options={})
    @options = options
  end

  def process(message, routing)
    message.body = YAML::load(message.body) rescue message.body
  end
end
</code></pre></div>
<p>The filter respects potential deserializing errors and just returns the message body in that case. Otherwise it just loads the objects from the message body. And that&#39;s the whole story.</p>

<p>Now you need to configure it in <code>config/messaging.rb</code> and you&#39;re good to go:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">ActiveMessaging::Gateway.define do |s|
  s.filter :deserialize_yaml_filter, :direction =&gt; :incoming
  s.filter :serialize_to_yaml_filter, :direction =&gt; :outgoing
end
</code></pre></div>
<p>The benefit? This way you can send more complex data structures (as opposed to just strings) through the broker:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">publish :my_queue, :action =&gt; &#39;do_stuff&#39;, :with =&gt; &#39;User&#39;, :id =&gt; 1
</code></pre></div>
<p>But remember to keep it simple. Don&#39;t try to stuff large objects through there. Sending over the user itself is very likely not a good idea, even more so when it&#39;s an ActiveRecord object.</p>

<p>More to come on a13g and Stomp.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page62" class="previous">Newer Posts</a>
    
  
  
    <a href="/page64" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
