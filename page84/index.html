<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2007/5/26/deploying_in_a_chroot_environment.html">Deploying in a chroot Environment with Capistrano</a></h3>
        <h4><a href="/2007/5/26/deploying_in_a_chroot_environment.html" title="Deploying in a chroot Environment with Capistrano">26 May 2007</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>A chroot environment seems to be rare these days. Everything is virtualized, load-balanced and what have you. I recently found myself trying to deploy into a chroot&rsquo;ed Lighttpd environment with Capistrano and immediately ran over several pitfalls. The biggest problem is that Capistrano uses absolute links for directories like <code>current</code> and the links to the <code>log</code> directory.</p>

<p>A base directory for your app could be <code>/var/www/rails</code> and your Lighttpd runs in a chroot environment in /srv/lighty. In the application directory Capistrano creates the directories <code>releases</code> and <code>shared</code>. After a successful deployment it also creates a symbolic link named <code>current</code> pointing to the latest release, and several links to directories in <code>system</code>.</p>

<p>In this scenario the link current would point to the directory
<code>/srv/lighty/var/www/rails/releases/20070506135654</code>. Now, since Lighttpd doesn&rsquo;t know the directory structure above /srv/lighty that&rsquo;s a bit of a problem and it won&rsquo;t find the path when you point it to the dispatcher in the directory <code>current</code>. This is true if you launch your Rails application through FastCGI. In a Mongrel scenario it would pretty much result in the same problems. Additionally, your Rails application won&rsquo;t find its <code>log</code> and other directories (if you&rsquo;re up for it, these are <code>public/system</code> and <code>tmp/pids</code>).</p>

<p>Apparently not many people seem to use an environment like this. It&rsquo;s pretty old-fashioned in this highly virtualized world, but you run across it from time to time. So what can you do?</p>

<h3>Hacking the Symbolic Links</h3>

<p>This isn&rsquo;t going to be pretty. To get the thing to work somehow I created a filter for <code>after_update_code</code> and removed the links created by Capistrano to replace them with new ones, only this time they wouldn&rsquo;t use absolute paths, but relative ones.</p>

<p>I&rsquo;m not proud of this solution, but I had to come up with something pretty quickly, and it works for the moment, and was only supposed to do so. It will be replaced with a production-like deployment soon. I&rsquo;ve replaced the task <code>:symlink</code> with my own which looks like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">desc &quot;Overwriting symlink task to 
task :symlink do
  on_rollback {
    run &quot;cd #{deploy_to} &amp;&amp; ln -nfs releases/#{File.basename previous_release} current&quot;
  }

  run &quot;cd #{deploy_to} &amp;&amp; ln -nfs releases/#{File.basename current_release} current&quot;

  run &lt;&lt;-CMD
    cd #{deploy_to} &amp;&amp;
    rm -f current/log current/public/system &amp;&amp;
    ln -nfs ../../shared/log current/log &amp;&amp;
    ln -nfs ../../../shared/system current/public/system
  CMD

  run &lt;&lt;-CMD
    test -d #{shared_path}/pids &amp;&amp; 
    rm -rf #{release_path}/tmp/pids &amp;&amp; 
    cd #{deploy_to} &amp;&amp;
    ln -nfs ../../../#{File.basename shared_path}/pids current/tmp/pids; true
  CMD
end
</code></pre></div>
<p>One remark: I remove some symlinks in the code, because Capistrano creates them in the <code>update_code</code> task.</p>

<p>As I said, it&rsquo;s not pretty but it works. Here&rsquo;s what it does: It removes the symbolic links created by Capistraon and replaces them with new ones using relative paths.</p>

<h3>Putting the user in a cage</h3>

<p>The better solution is to directly deploy into your chroot environment. Create a user that&rsquo;s directly being send into it by SSH or by its login shell.</p>

<p>This scenario requires that all the tools needed for a deployment must be installed in the chroot environment, including Subversion. If that&rsquo;s not a problem, this might be the ideal situation.</p>

<p>One thing you can&rsquo;t do is restart your web server from here. A scenario like this would mean that you can only restart your FastCGI or Mongrel processes. This is a scenario I&rsquo;ll use in the long run.</p>

<p>So is this hassle worth it? I&rsquo;m not sure myself. It&rsquo;s questionable, if the little added security is worth the effort you have to put in to get your applications working. In the end it depends on what your client&#39;s environment looks like, and if you have any control over it. If guidelines require chroot&rsquo;ed services, then there&rsquo;s not much you can do. Other than that I&rsquo;d consider breaking the service out of the chroot and trying to find a better way of securing it. Xen and the like come to mind.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2007/5/20/rubyfx_script_announced.html">RubyFX Script Announced</a></h3>
        <h4><a href="/2007/5/20/rubyfx_script_announced.html" title="RubyFX Script Announced">20 May 2007</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>At first I was rather disappointed by what <a href="http://www.sun.com/">Sun</a> announced with <a href="http://sun.com/javafx/">JavaFX</a>, the newest competitor in the RIA market. In my taste F3 looks rather ugly and has a way too expressive syntax, compared to, say SVG. The target&#39;s not the same between these two, I know that, but comparing what code you need to draw, SVG is a winner. Anyway, that&#39;s not really the point.</p>

<p>An announcement on <a href="http://conferences.oreillynet.com/rails/">RailsConf</a> shed a new light on JavaFX. A new framework called RubyFX is on a quest to close the gap between the DLR supporting Ruby and Sun&#39;s rather desperate attempt to get into the RIA market. The code looks very expressive, and to say the least, is what I&#39;m talking about. It&#39;s still early alpha, but it looks promising.</p>

<p>(Via <a href="http://www.almaer.com/blog/archives/001496.html">Dion</a>)</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2007/5/2/namespacing_your_rails_model_an.html">Namespacing Your Rails Model - An Afterthought</a></h3>
        <h4><a href="/2007/5/2/namespacing_your_rails_model_an.html" title="Namespacing Your Rails Model - An Afterthought">02 May 2007</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>In an earlier post I wrote about <a href="http://www.paperplanes.de/archives/2007/4/27/namespace_your_rails_model/">namespacing your Rails model</a>. There&#39;s an additional issue that must be thought of when doing so. Rails (of course) has conventions dealing with namespaces.</p>

<p>Normally, when you put classes in namespaces, like <code>Admin::User</code>, Rails normally expects this class to be in a folder <code>admin</code> in your <code>app/models</code> directory. Responsible for this is the method <code>load_missing_constant</code> in the module Dependencies, part of ActiveSupport. It also uses the namespace to build the table name. So <code>Admin::User</code> would result in <code>admin_users</code>. This isn&#39;t always a desirable outcome. Of course you could set a table name explicitly:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">class Admin::User &lt; ActiveRecord::Base
  set_table_name &quot;users&quot;
end
</code></pre></div>
<p>If you need to avoid namespace clashes, that&#39;s an acceptable option. But what if you only want to bring some order to your model directory? You want to create some subfolders to separate your model physically, if only to avoid having dozens of files in the model folder.</p>

<p>This is where <code>load_missing_constant</code> kicks in again. If you don&#39;t load the files in the subdirectories explicitly, it will assume that the files are in their according namespace. So having a class <code>User</code> in a file <code>user.rb</code> lying in the folder <code>app/models/admin/</code> will lead it to assume <code>User</code> exists in the module <code>Admin</code>. To avoid that you&#39;ll have to add your model subfolders as load paths. To do that you can add the following line to your environment.rb:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">config.load_paths += Dir[&quot;#{RAILS_ROOT}/app/models/[a-z]*&quot;]
</code></pre></div>
<p>This will tell Rails to look for the the files in all subfolders of <code>app/models</code> on startup. This won&#39;t solve the issue yet, you&#39;ll still need to explicitly load the classes. So you put the following lines at the end of your <code>environment.rb</code>:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">[ &quot;app/models&quot; ].each do |path|
  Dir[&quot;#{RAILS_ROOT}/#{path}/**/*.rb&quot;].each do |file|
    load file
  end
end
</code></pre></div>
<p>That way you&#39;ll avoid the implicit call to <code>load_missing_constant</code>. You can add directories to the list, e.g. a subdirectory in <code>lib</code>. You could also explicitly require the classes you need, but who wants to do that, really?</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page83" class="previous">Newer Posts</a>
    
  
  
    <a href="/page85" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
