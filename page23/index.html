<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. mathias meyer.</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. mathias meyer."/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <div id="articles">

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2012/7/5/six-ish-months-of-ebook-sales-riak-handbook.html">Six-ish Months of eBook Sales: Riak Handbook</a></h3>
        <h4><a href="/2012/7/5/six-ish-months-of-ebook-sales-riak-handbook.html" title="Six-ish Months of eBook Sales: Riak Handbook">05 July 2012</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>It&#39;s been slightly more than six months since I released the first version of
the <a href="http://riakhandbook.com">Riak Handbook</a>. It&#39;s been an amazing and
incredible ride so far, and it&#39;s about time I wrote about how things went from
the perspective of publishing, marketing and selling this book all on my own.
For this I draw inspiration from <a href="http://blog.studiofellow.com/2012/05/31/30k-ebook-sales-in-2-months/">Jarrod Drysdale&#39;s
post</a> on
his book <a href="http://bootstrappingdesign.com/">Bootstrapping Design</a> and <a href="http://jstorimer.com/2012/04/20/4-months-of-ebook-sales.html">Jesse
Storimer&#39;s post</a>
on the sales of his book <a href="http://workingwithunixprocesses.com/">Working With Unix
Processes</a>. Both books are awesome, by the
way, and well worth checking out.</p>

<h3>Introduction</h3>

<p>Originally I wanted to write a book on NoSQL. I called it &quot;NoSQL Handbook&quot;, and
I wanted it to cover the better-known NoSQL databases, including Riak, Redis,
Cassandra, CouchDB and MongoDB. That was in early 2011. I wrote a chapter on
MongoDB, but it didn&#39;t feel right to me, so I tried a different approach
on the Riak chapter, much more focused on being practical and introducing the
user-facing concepts in a streamlined way, building up as the book progresses.</p>

<p>That approach felt much more natural to me, so eventually I started on the Redis
chapter and thought I nailed it. I continued working on the Riak chapter
afterwards in a similar style. Focusing on practical and interesting usage made
it much more approachable to me, so I figured I might just do the same for
others. That&#39;s not exactly how you build a product, though, I was lucky that
so many customers agreed with this approach to writing the book.</p>

<p>The Riak chapter grew and grew, eventually it clocked in at 120 pages and kept
growing. My list of things to write about was long, it still is. So I turned to
<a href="http://unicornfree.com">Amy Hoy&#39;s</a> <a href="http://30x500.com/">30x500 class</a>, which I
was part of last winter, and brought up the idea of first creating a product
focused on a single database and to follow up with the bigger book later on.</p>

<p>I started to like the idea, and was encouraged by Amy to try this route. Six
months later, going down that route was a success, though there was no guarantee
at all it would end up being one.</p>

<p>Let&#39;s look at the numbers.</p>

<h3>Numbers, Spikes, Cause and Effect</h3>

<p>It&#39;s weird talking about this, because it involves sales numbers, money and
being very open about the selling part of the book. It feels weird because not a
lot of people selling products do it. It feels weird because book authors are
usually not very open about the royalties they get. I have the most respect for
anyone writing a book, make no mistake. But I do want to encourage people
to go down the self-publishing route, to build products, to write books, 
sell and market them.</p>

<p>Since the book went on sale on December 15th 2011, it has sold 746 copies to
this very day, grossing in at a total of $22,007.67. 8.9% of that go to my
fulfillment provider, leaving a profit of $20,048.99. The total splits into 7
site licenses and the 739 single licenses.</p>

<p>It&#39;s hard to express how grateful I am. The number of sales have exceeded my
wildest expectations. I thought if I got to $2,000 I would strike off the book
as a success. I was insanely happy when I reached 2k, every step afterwards I
could hardly believe, eventually reaching an unbelievable milestone of $10,000.</p>

<p>But on the other hand, maybe the sales numbers aren&#39;t entirely a coincidence.
Here&#39;s a graph representing sales in the last six months.</p>

<p><img src="http://s3itch.paperplanes.de/FastSpring_SpringBoard___Report_Dashboard-2-20120628-233535.png" alt="Sales"></p>

<p>There&#39;s a huge and a smaller spike at the beginning and several smaller spikes
along the way. Even though I can&#39;t put my finger on all of the smaller spikes
(something which I must work on for sure), there are some that can be explained
in terms of marketing. Let&#39;s put some context on each and see what happened.</p>

<p><img src="http://s3itch.paperplanes.de/FastSpring_SpringBoard___Report_Dashboard-1-20120628-233439.png" alt="Sales"></p>

<p>The first spike is the first day of publishing the book. I ended up selling 89
copies on the first day, 52 on the second. The book got posted on HackerNews,
and so did an <a href="/2011/12/15/storing-timelines-in-riak.html">article on building activity feeds with
Riak</a> that I published the same day.</p>

<p>The Monday after the release I sent out a newsletter to everyone who signed up
for the NoSQL Handbook, some 1400 people. That&#39;s the second spike, and it sold
some 70 books in total, looking at the first three days of the newsletter going
out. Some sales kept trickling in from that newsletter over the following days
too.</p>

<p>The next spike is in early February. If you&#39;re into NoSQL you&#39;ll remember Amazon
releasing their new cloud database offering
<a href="http://aws.amazon.com/dynamodb/">DynamoDB</a> to the public in January. I wrote a
<a href="/2012/1/30/a-tour-of-amazons-dynamodb.html">long post about it</a> discussing its
features and how I thought (still do) it&#39;s different from Dynamo, Amazon&#39;s
original distributed database whose ideas Riak was built on. Interestingly, that
article brought quite a few sales of the book.</p>

<p>It&#39;s curious because the article is only slightly related to the contents of the
book but still builds up enough interest for people to dig deeper into the roots
of both Riak and DynamoDB. The book covers a pretty good ground in terms of
where Riak comes from and the theories and ideas behind it. In total that
article got somewhere around 20,000 views in just a few days.</p>

<p>The last spike is the 1.1 update that I released in late May. I put the book on
sale for a week, with a 25% discount and sold quite a few copies in that time.</p>

<h3>Marketing</h3>

<p>The interesting bit about marketing started not too long before I published the
book. Following Amy&#39;s suggestion I worked my way up to the launch by publishing
three blog posts around Riak. That was also the first time I publicly dropped my
intention of publishing a book on Riak, the &quot;Riak Handbook&quot;.</p>

<p>It&#39;s hard to put numbers on that kind of marketing, but it certainly helps a lot
to build up excitement and interest for an upcoming product.</p>

<p>The really hard part about it all was writing the copy for the website. Bringing
out the value of the book for someone interested in Riak is hard, really hard. I
think I did okay for my first ever try writing what you&#39;d call marketing copy,
but only the people who did or didn&#39;t buy the book can be the judge of that.</p>

<p>Picking up the spirit of Seth Godin, I&#39;d certainly do more variations on copy
and website and do more in-depth testing on a future product instead of leaving
it the way it is for too long. I&#39;d also experiment with different ways of
underlining the existence of the site license.</p>

<p>The same is true for the newsletter. Writing an email to 1400 people, people
that&#39;d see my copy prose and that&#39;d read my email, that was scary. It took me
full day to write the text, lay out the email, re-read it multiple times and to
finally hit that send button.</p>

<p>It was really, really scary. It felt like being exposed to an unknown public
with my pants off. But then again, these people showed interest in what I&#39;m
working on by signing up. That&#39;s what eventually pushed me over the edge to hit
send.</p>

<p>The newsletter helped a lot, so did the initial blog posts and other blog posts
following over time. Regularly writing and publishing something related to the
book, related to Riak, being helpful on IRC and on the Riak mailing list made a
difference too. It got people curious about the book. That&#39;s the first step. I
need to work on the second step, taking the customer from there.</p>

<p>As a last thought, the best kind of marketing you can get is word of mouth.
Great, sincere and personal customer support goes a long way. If someone has a
problem, you help them fix it, you help them get along, even if you&#39;re not to
blame. People will remember that and tell others about it. The same is true for
offering sincere apologies to people who are annoyed for valid reasons. With the
right kind of support you can turn them into loyal customers. An apology goes a
long way.</p>

<h3>The Price</h3>

<p>When I worked towards a beta of the NoSQL Handbook, I figured I&#39;d start selling
it for $12 and the final book for double that amount. After going through Amy&#39;s
process and reading some of
<a href="http://unicornfree.com/2010/a-simple-rule-for-pricing-newbs-who-got-the-fear/">her</a>
<a href="http://unicornfree.com/2011/biz-book-friday-cost-plus-pricing-price-obsession/">excellent</a>
<a href="http://unicornfree.com/2011/will-low-prices-sell-more/">blog</a>
<a href="http://unicornfree.com/2011/raising-the-price-not-a-single-customer-lost/">posts</a>
<a href="http://unicornfree.com/2011/pricing-your-product-the-dd-test/">on</a>
<a href="http://unicornfree.com/2011/when-customers-bitch-about-your-price-biz-book-friday/">pricing</a>
I reconsidered. I bumped up the price for the Riak Handbook alone to $19. After
talking to some of my reviewers (who are awesome, thank you guys so much!) I
raised it to $25. Giving it some more thought I settled on $29.</p>

<p>Let&#39;s look at how that worked out. To make the same amount with $19, I&#39;d have to
sell 1158 copies. That&#39;s more than 50% more sales I&#39;d have to have made,
which feels unlikely to me. Cheaper price doesn&#39;t automatically mean more books
sold. The value of the book to the customer, to people genuinely interested in
learning about Riak, is what really matters. The price follows the value, not
what feels right.</p>

<p>Looking back, I had only very few complaints about the price. Given that the
book just got a huge update and it&#39;s going to get more over the next months, I&#39;m
still pondering the price in the longer term.</p>

<h3>The Rest</h3>

<p>As I said before, it has been amazing experience. Selling something you&#39;ve built
yourself gives you a totally new kind of insight in building a business around
products, in developing customer relationships, in providing value to the people
to whom it matters the most.</p>

<p>You appreciate every single customer. You get to build a personal relationship
with every one of them, should you choose to and should they accept your offer.
Compare that with a traditional publisher, where you just get paid by the
publisher, and you&#39;ll never know who your readers are unless they write a review
about your book somewhere.</p>

<p>As a self-publisher, you also get to redefine the process of publishing. You
don&#39;t have to just ship a finished book and leave it at that like most
traditional publishers. For example, the book&#39;s recent update clocked in at more
than 40 pages of new contents, which existing customers got for free.</p>

<p>The update also included the entire book as a man page. The idea still cracks me
up, but just think how useful that is. Customers can search the book quickly and
never have to leave the command line they spend so much time in.</p>

<p>Or you can ditch the book format entirely like Steve Klabnik did with his
<a href="http://designinghypermediaapis.com/">Designing Hypermedia APIs</a>. You get to
decide how you want to publish your product, and you get to validate if it&#39;s the
right approach or not.</p>

<p>I&#39;m still working on pushing the book forwards, adding more contents, updating
examples and texts for new Riak releases, improving things as I go along. And
yes, that means there&#39;s more free updates in the future. You should check out
<a href="http://riakhandbook.com">the book</a> if you like that idea :)</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2012/6/29/june-reading-list.html">June Reading List</a></h3>
        <h4><a href="/2012/6/29/june-reading-list.html" title="June Reading List">29 June 2012</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>I&#39;ve been on vacation in France for most of June, and that means lots of time to
read. Originally I planned on reading more on distributed systems, but I had a
decent backlog of books on my Kindle, so this was just the right time to plow
through them. By the way, if you don&#39;t have a Kindle yet, you should get one.
It&#39;s a great little device. I&#39;ve been reading so much more since I got it.
Anyhoo, here&#39;s the list of books I&#39;ve been reading in June.</p>

<p><a href="http://amzn.to/MW3fhv"><strong>Java Concurrency in Practice</strong></a> by Brian Goetz. This
is a classic on programming for concurrency in Java. While all the code examples
are Java, they&#39;re just as easy to understand, and should be easily applicable to
your programming language of choice. Given, of course, that there are libraries
offering similar data structures.</p>

<p>The book goes through great length discussing what&#39;s wrong with just using
threads and synchronizing access to data and how newer concurrent APIs in Java
can help you avoid the hassle. It covers a mind-boggling number of details and
data structures. Concurrent collections, designing thread-safe code, latches,
barriers, queues, atomic data types, locks, semaphores, deadlocks, thread
liveness, execution pools and so on. The part that really surprised me was the
insight on the JVM&#39;s memory model, and why you need to protect data structures
when it&#39;s shared across threads and multiple cores and processors.  A must-read
when it comes to programming for concurrency, and not just on the JVM. This book
is a true gem.</p>

<p><a href="http://amzn.to/LN4qm3"><strong>Designing With Data</strong></a> by Brian Suda. A great, short
introduction to visualizing data. The book is for everyone new to the area of
graphing and exploring data. Don&#39;t expect a thorough introduction on statistics
and everything around the numbers. The book focuses more on introducing the
reader to the different types of graphs, why and when they work and also why
some of them don&#39;t work.</p>

<p><a href="http://amzn.to/KAog1y"><strong>Scalable Internet Architectures</strong></a> by Theo
Schlossnagle. This book was written in 2007 and was way ahead of its time. Never
mind the examples being mostly in Perl, this book covers all the little details
on what it takes to build scalable web applications. Heck, it even shows you how
you can build your own cross-vendor database replicator. A highly recommended
read. It&#39;s right up there with <a href="http://amzn.to/MFlJVg"><strong>Release It!</strong></a> by
Micheal Nygard, which you should read too.</p>

<p><a href="http://amzn.to/MW3Dge"><strong>Small Is The New Big</strong></a> by Seth Godin. I gotta admit,
I haven&#39;t read anything by Seth so far, but this was a great start. It&#39;s a
collection of 183 posts from his blog, carefully selected to represent little
stories on why big companies fail and how small companies can succeed. It&#39;s a
great read, I&#39;m amazed how well Seth can take small examples like chucking a
large pile of jewel cases and extrapolate them into a big picture to examplify
why the music industry is doomed. Looking forward to reading more of his books.</p>

<p><a href="http://amzn.to/KAoxBm"><strong>Drive: The Surprising Truth About What Motivates Us</strong></a>
by Daniel Pink. The title says it all, the book explores, through scientific
(but not at all boring) analysis, why money is not our sole motivator. We have
an inner drive to expand our personal horizons, to master what we do every day
and to work towards a purpose bigger than ourselves. Tom Preston-Werner (of
GitHub) recommended the book at a conference, and you can see how it reflects
the work culture at GitHub. Fits in very well with the aforementioned book.</p>

<p><a href="http://amzn.to/MW4E7M"><strong>Programming Concurrency on the JVM</strong></a> by Venkat
Subramaniam. This book picks up where &quot;Java Concurrency in Practice&quot; left off. To
recap things in terms of more traditional synchronization and concurrency APIs
it builds on several simple examples that are being rebuilt constantly using new
tools as the book progresses. The interesting bits are the part that covers
software transactional memory and actors, both mostly focusing on
<a href="http://akka.io">Akka</a>.</p>

<p>As the title suggests this book is very code-heavy, which sometimes, at least on
the Kindle, is a bit unreadable. It takes you through all the details of using
STM and actors, both in Java and Scala, but also with examples in Groovy, JRuby
and Clojure. This is pretty neat, because you pick up some new things along the
way.  I&#39;d wish for some more depth here and there but I feel much better
informed on STM and actors after reading it.</p>

<p><a href="http://amzn.to/MW4MnQ"><strong>Knack</strong></a> by Norm Brodsky and Bo Burlingham. A book
focused around founding, running and growing a business, this one is full of
stories from the author&#39;s experiences with his businesses, beginning as
start-ups, growing into big yet still customer-focused and in their own right
still small companies.</p>

<p>Added to the mix are stories from people and companies the Norm has advised over
the years. You don&#39;t have to believe or take for granted everything he has to
say and recommends doing or not doing, but this one is a great read either way,
very much so because it is full of stories. If you read &quot;Drive&quot; and &quot;Small Is
The New Big&quot;, you&#39;ll find similar patterns occurring in all of them.</p>

<p>As days go by this book keeps coming back to me. Lots of little details that I
want to apply to my own business practices. The more I think about it the more I
think you should read this book.</p>

<p><a href="http://amzn.to/LN5cj0"><strong>Clojure Programming</strong></a> by Chas Emerick, Brian Carper
and Christophe Grande. Clojure pushes all the right buttons for me as a
language, and this book so far has helped me grasp more and more of it. While
some of the code examples aren&#39;t very practical and introduce new concepts
without discussing them here and there, the book is still a great introduction
to the language. I just wish it wasn&#39;t &gt; 600 pages, but still, lots of contents
to plow through.</p>

<p><a href="http://amzn.to/QxutQq"><strong>Pricing with Confidence</strong></a> by Reed Holden. I came
across this book by way of Amy Hoy&#39;s
<a href="http://unicornfree.com/2011/biz-book-friday-cost-plus-pricing-price-obsession/">blog</a>
<a href="http://unicornfree.com/2011/will-low-prices-sell-more/">posts</a> on
<a href="http://unicornfree.com/2011/when-customers-bitch-about-your-price-biz-book-friday/">pricing</a>.
The book deserved an emergency spot on my reading list because it&#39;s very
relevant for the product I&#39;m currently working on. The book&#39;s focus is on basing
the price of a product on its value to the customer. Granted, I just started
reading it, but so far it reads well and the points make a lot of sense. If
you&#39;re looking to dive deeper into pricing your products, there&#39;s also <a href="http://neildavidson.com/download/dont-just-roll-the-dice/">Don&#39;t
Just Roll The Dice</a>,
whose PDF version is available as a free download.</p>

<p>Now go read!</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

  <article>
    <div class="item">
      <div class="item_details">
        <h3><a href="/2012/6/27/playing-with-riak-and-crdts.html">Playing with Riak and CRDTs - Counters</a></h3>
        <h4><a href="/2012/6/27/playing-with-riak-and-crdts.html" title="Playing with Riak and CRDTs - Counters">27 June 2012</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </div>
      <div class="item_content">
        <p>I recently spent some quality time with CRDTs, which is short for commutative
replicated data types. I&#39;ve gotten curious about them when working on the <a href="http://riakhandbook.com">Riak
Handbook</a> and I gave a talk about designing data
structures for Riak the other week at <a href="http://www.nosql-matters.org/cgn2012/#mathias_meyer">NoSQL
matters</a>, <a href="https://speakerdeck.com/u/roidrage/p/designing-for-concurrency-with-riak">slides are
available
too</a></p>

<p>What are commutative replicated data types? It&#39;s a fancy term for describing
data structures suitable for eventually consistent systems. You know what&#39;s an
eventually consistent system? Riak!</p>

<p>When working with Riak, your data needs to be designed in a way that allows
coping with its eventually consistent nature. This poses a problem for data
types like counters, sets, graphs, essentially all data structures that require
operations to be executed in a monotonic fashion.</p>

<p>For instance, with a counter, you don&#39;t want to lose a single increment when
multiple clients add values. But due to Riak&#39;s eventually consistent nature you
can&#39;t guarantee monotonic order of updates. Instead you need to make sure you
can restore a logical order of operations at any time given any number of
conflicting writes.</p>

<p>When multiple clients update the same object concurrently they cause siblings,
two objects with different values. If every sibling has a different value for
the counter, how do you make sure you can restore order and therefore the
final value? Let&#39;s look at a worst-case scenario of a data structure that won&#39;t
work well in this case. Two clients see an object already stored in Riak
representing a counter, currently having the value 1.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;value&quot;: 1
}
</code></pre></div>
<p>Two clients now want to update the counter, incrementing its value by 1. They
both store the updated data back to Riak, causing a conflict. Now you have two
siblings, both having the value 2. You also have the original sibling around as
referenced by both clients when they wrote their data.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;value&quot;: 2
}
</code></pre></div>
<p>It&#39;s unlikely you&#39;ll be able to restore the total sum of both values, because
you don&#39;t know what the previous value for both clients was. You can assume the
value was 1, but what if a client incremented by 2? In an eventually consistent
system it&#39;s hard to say how much has changed since the last time you&#39;ve seen the
data unless you keep track specifically of what has changed.</p>

<p>Commutative replicated data types are data structures designed to help you here.
Let&#39;s look at an alternative for a counter. What if, instead of keeping a single
value, every client keeps its own value and only updates that number instead of
the total value?</p>

<p>We can assume that updates of a single client will happen in a monotonic
fashion. There shouldn&#39;t be more than one client with the same identifier in the
system.</p>

<p>Here&#39;s an example of our updated data structure:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;client-1&quot;: 2,
  &quot;client-2&quot;: 2,
  &quot;client-3&quot;: 3
}
</code></pre></div>
<p>When a client wants to update a value he only updates its own value. It&#39;s a
contract between all clients to never touch any other client&#39;s data other than
merge it back together. When a client finds an object with siblings it can merge
them together simply by picking the highest value for every client. Part of the
contract is also that a client must merge the data when it finds an object with
siblings.</p>

<p>To get the total value for the counter, just calculate the sum of all values, et
voila! This surprisingly simple data structure is called G-counter.</p>

<p>Let&#39;s look at some code. I&#39;m assuming your bucket has support for siblings
enabled.</p>

<p>The bits to generate a counter value are straight-forward. You just have to make
sure to assign unique but recurring client identifiers to your client objects.
Here we&#39;re using the Ruby client.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;riak&#39;

riak = Riak::Client.new(client_id: &#39;client-1&#39;)
counter = riak.bucket(&#39;g-counters&#39;).get_or_new(&#39;counter-1&#39;)

counter.data ||= {}
counter.data[riak.client_id] ||= 0
counter.data[riak.client_id] += 1
counter.store
</code></pre></div>
<p>After initializing the data structure we&#39;re assigning it a default, if
necessary and increment the counter. This code can nicely be hidden in a library
function somewhere. The interesting bit is merging the data structures back
together should the client find siblings. The Ruby client has a convenient way
to specify callbacks that should be called when more than one object is
returned.</p>

<p>We&#39;re writing code that iterates over all siblings, picking the highest value
for every client along the way.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Riak::RObject.on_conflict do |robject|
  return nil if robject.bucket != &#39;g-counters&#39;
  data = robject.siblings.each_with_object({}) do |sibling, data|
    (sibling.data || {}).each do |client_id, value|
      if (data[client_id] || 0) &lt; value
        data[client_id] = value
      end
    end
  end
  robject.data = data
  robject
end
</code></pre></div>
<p>The next time you fetch the data and the Ruby client detects a conflict the
callback will be run, merging the data back together into a single data
structure.</p>

<p>I&#39;ll leave the code to calculate the sum of all values as an exercise to the
reader.</p>

<p>All this assumes that you&#39;re enforcing a stronger consistency on your data. You
need to make sure that R + W &gt; N, because even when one client only updates its
own values, he has little control over where its data is written. When you don&#39;t
make sure that consistency of data is enforced you can run into situations where
a client comes across two siblings caused by its own updates. This can happen
when a primary replica failed, a secondary replica took its place and the client
only uses a small read quorum. These scenarios deserve their own write-up.</p>

<p>If you want to know more about commutative replicated data types I highly
suggest reading <a href="http://hal.inria.fr/docs/00/55/55/88/PDF/techreport.pdf">the relevant
paper</a> on them. It&#39;s
almost fifty pages long and required me several reads to get a good grasp of
them, but it&#39;s totally worth it. There are more specific implementations
available for CRDTs too, specifically <a href="https://github.com/mochi/statebox">statebox for
Erlang</a>, <a href="https://github.com/reiddraper/knockbox">knockbox for
Clojure</a> and <a href="https://github.com/aphyr/meangirls">a sample implementation in
Ruby</a>. The latter comes with a handy README
that shows examples for the specific data types. All of them aren&#39;t specific to
Riak but can be used with it. Also fresh from the world of academic papers is
this one by Neil Conway et. al. on lattices in distributed computing by way of
<a href="http://bloom-lang.org/">Bloom</a>, a language for disorderly distributed computing.</p>

<p>There are some other caveats with CRDTs and Riak but we&#39;ll look at them in more
detail in another installment of this series, in particular regarding
consistency and garbage collection. There&#39;s a lot to be said about CRDTs and
there&#39;s a lot of brain matter to be spent on trying to understand them. The next
update for <a href="http://riakhandbook.com">Riak Handbook</a> might even include a section
on them. The topic is certainly fascinating enough to warrant one, as it
addresses the issues people commonly encounter when designing data structures
for eventual consistency.</p>

      </div>
      <div class="item_meta">
        <span class="item_tags">
          Tags: 
          
        </span>
      </div>
    </div>
  </article>

</div>

<div class="pagination">
  
    
      <a href="/page22" class="previous">Newer Posts</a>
    
  
  
    <a href="/page24" class="next">Older Posts</a>
  
</div>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
