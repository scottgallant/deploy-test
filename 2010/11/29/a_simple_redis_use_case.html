<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>paperplanes. A Simple Redis Use Case for Sorted Sets</title>
    <meta name="robots" content="index,follow"/>
    <meta name="mssmarttagspreventparsing" content="true"/>
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif" />
    <link rel="icon" href="/images/favicon.gif" type="image/gif" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  	<meta name="author" content="Mathias Meyer"/>
    <meta name="dc.title" content="paperplanes. A Simple Redis Use Case for Sorted Sets"/>
  	<link rel="start" href="http://www.paperplanes.de" title="paperplanes"/>
     
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="A Simple Redis Use Case for Sorted Sets"/>
    <meta name="twitter:site" content="@roidrage"/>
    <meta name="twitter:creator" content="@roidrage"/>
    <meta name="twitter:description" content="Interested in Redis? You might be interested in the Redis Handbook I&#39;m currently working on.

Over at Scalarium we constantly find outselves adding new statistics to track specific parts of
the..."/>
    <meta name="twitter:url" content="http://www.paperplanes.de/2010/11/29/a_simple_redis_use_case.html"/>
    <meta name="twitter:domain" content="paperplanes.de"/>
    
    <link href="http://www.paperplanes.de/rss.xml" rel="alternate" title="Primary Feed" type="application/rss+xml" />
    <link href="/stylesheets/screen.css" media="screen" rel="Stylesheet" title="paperplanes" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/mobile.css" media="handheld, only screen and (max-device-width: 960px)" />
  </head>
  
  <body id="www-paperplanes-de">
    <div id="head">
      <div id="header-content">
        <a href="/">
          <img src="/images/paperplane.png" id="paperplane">
        </a>
        <div id="about">
          <h1 class="default">Hi, I'm Mathias Meyer, nice to meet you!</h1>
          <h1 class="mobile">Hi, I'm <a href="https://twitter.com/roidrage">Mathias Meyer</a>, I'm the CEO at <a href="https://travis-ci.com">Travis CI</a></h1>
          <p style="color: white" class="about-sub-title default">
            I'm the CEO at <a href="http://travis-ci.com">Travis CI</a>. I like coffee, <a href="https://twitter.com/roidrage">Twitter</a> and <a href="mailto:meyer@paperplanes.de">email</a>.
          </p>
        </div>
      </div>
    </div>

    <div id="box">
      <div id="content">
        <article class="hentry">
  <div class="item_perma">
    <div class="item_details">
      <header>
        <h3 class="entry-title">A Simple Redis Use Case for Sorted Sets</h3>
        <h4><a href="/2010/11/29/a_simple_redis_use_case.html" title="Permalink for this post">29 November 2010</a> by <a href="http://twitter.com/roidrage">Mathias Meyer</a></h4>
      </header>
    </div>
    <div class="item_content">
      <p><em>Interested in Redis? You might be interested in the <a href="http://redishandbook.com">Redis Handbook</a> I&#39;m currently working on.</em></p>

<p>Over at <a href="http://scalarium.com">Scalarium</a> we constantly find outselves adding new statistics to track specific parts of
the system. Thought it&#39;d be a good idea to share some of them, and how we&#39;re using Redis to store them.</p>

<p>Yesterday I was looking for a way to track the time it takes for an EC2 instance to boot up. Booting up in this case
means, how long it takes for the instance to change from state &quot;pending&quot; to &quot;running&quot; on EC2. Depending on utilization
and availability zone this can take anywhere from 30 seconds to even 30 minutes (us-east, I&#39;m looking at you). I want to
get a feel for how long it takes on average.</p>

<p>We poll the APIs every so many seconds, so we&#39;ll never get an exact number, but that&#39;s fine. It actually makes the
tracking easier, because the intervals are pretty fixed, and all I need to do is store the interval and increment a
number.</p>

<p>Sounds like a job for a sorted set. We could achieve similar results with a hash structure too, but let&#39;s look at the
sorted set nonetheless, because it&#39;s pre-sorted, which suits me well in this case. For every instance that&#39;s been booted
up I simply store the interval and increment the number of instances.</p>

<p>In terms of a sorted set, my interval will be the member in the sorted set and the number of instances falling into that
particular interval will be the score, the value determining the member&#39;s rank. Advantage here is that the set will
automatically be sorted by the number of instances in that particular interval, so that e.g. the interval with the most
instances always comes first.</p>

<p>We don&#39;t need anything to get started, we just have to increment the score for the particular interval (or member), in
this case 60 seconds, Redis will start from zero automatically, I&#39;ll use the Redis Ruby library for brevity.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zincrby(&#39;instance_startup_time&#39;, 1, 60)
</code></pre></div>
<p>Another instance took 120 seconds to boot up, so we&#39;ll increment the score for that interval too.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zincrby(&#39;instance_startup_time&#39;, 1, 120)
</code></pre></div>
<p>After some time we have added some good numbers to this sorted set, and we can start keeping an eye on the top five.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zrevrange(&#39;instance_startup_time&#39;, 0, 4, :with_scores =&gt; true)
# =&gt; [&quot;160&quot;, &quot;22&quot;, &quot;60&quot;, &quot;21&quot;, &quot;90&quot;, &quot;10&quot;, &quot;120&quot;, &quot;10&quot;, &quot;40&quot;, &quot;5&quot;]
</code></pre></div>
<p>The default sort order is ascending in a sorted set, hence we&#39;ll get a reverse range (using the <code>zrevrange</code> command) of
the five intervals with the highest score, i.e. where the most instances fall into.</p>

<p>To get the number of instances for a particular interval, we can use the <code>zscore</code> command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zscore(&#39;instance_startup_time&#39;, 60)
# =&gt; 21
</code></pre></div>
<p>To find the rank in the sorted set for a particular interval, e.g. to find out if it falls into the top five intervals,
use <code>zrevrank</code>.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zrank(&#39;instance_startup_time&#39;, 160)
# =&gt; 0
</code></pre></div>
<p>Now we want to find the intervals where a particular number of instances fall into, say everything from 10 to 20
instances. We can use <code>zrangebyscore</code> for this purpose.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zrangebyscore(&#39;instance_startup_time&#39;, 10, 20, :with_scores =&gt; true)
# =&gt; [&quot;120&quot;, &quot;10&quot;, &quot;90&quot;, &quot;10&quot;] 
</code></pre></div>
<p>Note that Redis has some nifty operators where you can e.g. ask for every interval that has more than 10 instances,
using the <code>+inf</code> operator, useful when you don&#39;t know the highest score in the sorted set.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zrangebyscore(&#39;instance_startup_time&#39;, 10, &#39;+inf&#39;, :with_scores =&gt; true)
# =&gt; [&quot;120&quot;, &quot;10&quot;, &quot;90&quot;, &quot;10&quot;, &quot;60&quot;, &quot;21&quot;, &quot;160&quot;, &quot;22&quot;]
</code></pre></div>
<p>Now you want to sort the sorted set by the interval, e.g. to display the numbers in a table. You can use the <code>sort</code>
command to sort the set by its elements, but unfortunately there doesn&#39;t seem to be a way to get the scores in the same
call.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.sort(&#39;instance_startup_time&#39;)
# =&gt; [&quot;20&quot;, &quot;40&quot;, &quot;60&quot;, &quot;90&quot;, &quot;120&quot;, &quot;160&quot;]
</code></pre></div>
<p>To make up for this you could iterate over the results and fetch the results in one go using the <code>multi</code> command.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">members = redis.sort(&#39;instance_startup_time&#39;)
redis.multi do
  members.each do |member|
    redis.zscore(&#39;instance_startup_time&#39;, member)
  end
end
</code></pre></div>
<p>So far we&#39;ve stored all numbers in one big sorted set, which will grow over time, making the statistical numbers very
broad and less informative. Suppose we want to store daily metrics and then run the numbers weekly and monthly. We just
used a different key derived from the current date.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">today = Date.today.strftime(&quot;%Y%m%d&quot;)
redis.zincrby(&quot;instance_startup_time:#{today}&quot;, 1, 60)
</code></pre></div>
<p>Suppose we have collected data in the last two days. Thanks to <code>zunionstore</code> we can add the two sets together. Assume
you have data from all days of the week, then you can use <code>zunionstore</code> to accumulate that data and store it with a
different key.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zunionstore(&#39;instance_startup_time:week49&#39;,
                  [&#39;instance_startup_time:20102911&#39;, &#39;instance_startup_time:20103011&#39;])
</code></pre></div>
<p>This will create a union of the sorted sets for the two subsequent days. The neat part is that will aggregate the data
of the elements in the sets. So if on the one day 12 instances took 60 seconds to start and on the second 15, Redis will
create the sum of all the scores. Neat, huh? What you get is a weekly aggregate of the collected data, of course it&#39;s
easy to create monthly data as well.</p>

<p>Instead of summing up the scores you could also store the maximum or minimum across all the sets.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">redis.zunionstore(&#39;instance_startup_time:week49&#39;,
                  [&#39;instance_startup_time:20102911&#39;, &#39;instance_startup_time:20103011&#39;],
                  :aggregate =&gt; &#39;max&#39;)
</code></pre></div>
<p>Of course you could save the extra union and just create counters for days, weeks and months in one go, but that
wouldn&#39;t give me much material to highlight the awesomeness of sorted set unions now, wouldn&#39;t it?</p>

<p>You could achieve a similar data structure by using hashes, but you can do some neat things on sorted sets that you&#39;d
have to implement manually with hashes. Sorted sets are pretty neat when you need a weighed counter, e.g. download
statistics, clicks, views, prelisted by the number of hits (scores) for the particular element.</p>

    </div>
    <div class="item_meta">
      <div class="item_tags">Tags:
        
      </div>
      <div class="item_hierarchy">Hierarchy:
        
          <a href="/2010/10/12/why_riak_search_matters.html" title="Previous post">previous</a>
        
        
        
          , <a href="/2011/1/5/the_virtues_of_monitoring.html" title="Next post">next</a>
        
        </div>
    </div>
  </div>
</article>

       
        <div id="footer">
          <div id="footer_text">
            <a href="/archives.html">Archives</a>, <a href="http://www.paperplanes.de/rss.xml" title="Full-text RSS feed">RSS Feed</a>, &copy; 2007-2014 Mathias Meyer <a href="/imprint.html">Imprint</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46305173-1', 'paperplanes.de');
      ga('send', 'pageview');

    </script>
  </body>
  <script src="//my.hellobar.com/7db1d1ae6111ae95568efbbf8e6a1ee953ad854f.js" type="text/javascript" charset="utf-8" async="async"></script>
</html>
